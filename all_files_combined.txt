COMBINED CONTENT FROM FOLDER: C:\Users\Vishal\Documents\hospital_final_backend\app\models
==================================================

FILE: __init__.py
----------------------------------------
"""
SQLAlchemy Models for Hospital Management System
All models use SQLAlchemy 2.0 syntax with PostgreSQL
"""

from app.core.database import Base

# Import all models for Alembic migration detection
from .base import BaseModel, TimestampMixin, SoftDeleteMixin
from .floor import Floor
from .hospital import Hospital
from .branch import Branch
from .department import Department
from .ward import Ward
from .room import Room
from .bed import Bed
from .patient import Patient
from .doctor import Doctor
from .nurse import Nurse
from .staff import Staff
from .appointment import Appointment
from .admission import Admission
from .discharge import Discharge
from .lab_test import LabTest
from .lab_report import LabReport
from .medicine import Medicine
from .prescription import Prescription
from .pharmacy import Pharmacy
from .billing import Billing
from .payment import Payment
from .insurance import Insurance
from .ambulance import Ambulance
from .emergency import Emergency
from .operation import Operation
from .imaging import Imaging
from .equipment import Equipment
from .inventory import Inventory
from .supplier import Supplier
from .vendor import Vendor
from .purchase_order import PurchaseOrder
from .expense import Expense
from .revenue import Revenue
from .attendance import Attendance
from .leave import Leave
from .shift import Shift
from .schedule import Schedule
from .payroll import Payroll
from .event import Event
from .notification import Notification
from .message import Message
from .chat import Chat
from .complaint import Complaint
from .feedback import Feedback
from .faq import FAQ
from .setting import Setting
from .role import Role
from .role_permission import RolePermission
from .api_key import APIKey
from .audit_log import AuditLog
from .activity_log import ActivityLog

__all__ = [
    # Base
    "Base",
    "BaseModel",
    "TimestampMixin",
    "SoftDeleteMixin",
    
    # Core Infrastructure
    "Floor",
    "Hospital",
    "Branch",
    "Department",
    "Ward",
    "Room",
    "Bed",
    
    # People
    "Patient",
    "Doctor",
    "Nurse",
    "Staff",
    
    # Medical Services
    "Appointment",
    "Admission",
    "Discharge",
    "LabTest",
    "LabReport",
    "Medicine",
    "Prescription",
    "Pharmacy",
    "Emergency",
    "Operation",
    "Imaging",
    
    # Financial
    "Billing",
    "Payment",
    "Insurance",
    "Expense",
    "Revenue",
    "Payroll",
    
    # Resources
    "Ambulance",
    "Equipment",
    "Inventory",
    "Supplier",
    "Vendor",
    "PurchaseOrder",
    
    # HR Management
    "Attendance",
    "Leave",
    "Shift",
    "Schedule",
    
    # Communication
    "Event",
    "Notification",
    "Message",
    "Chat",
    "Complaint",
    "Feedback",
    "FAQ",
    
    # System
    "Setting",
    "Role",
    "RolePermission",
    "APIKey",
    "AuditLog",
    "ActivityLog",
]


==================================================

FILE: activity_log.py
----------------------------------------
"""
Activity Log Model
User activity tracking (lightweight version of audit log)
"""

from sqlalchemy import Column, Integer, String, Text, Index
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class ActivityLog(BaseModel):
    """
    User activity log model
    """
    
    __tablename__ = "activity_logs"
    
    # User
    user_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    user_name: Mapped[str] = mapped_column(String(200), nullable=False)
    user_type: Mapped[str] = mapped_column(String(50), nullable=False)
    
    # Activity
    activity_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="login, logout, page_view, action, download, upload"
    )
    
    # Description
    description: Mapped[str] = mapped_column(String(500), nullable=False)
    
    # Metadata
    metadata: Mapped[Optional[str]] = mapped_column(Text, comment="JSON additional info")
    
    # Session
    session_id: Mapped[Optional[str]] = mapped_column(String(100), index=True)
    
    # Device Info
    ip_address: Mapped[Optional[str]] = mapped_column(String(50))
    device_type: Mapped[Optional[str]] = mapped_column(String(50), comment="desktop, mobile, tablet")
    browser: Mapped[Optional[str]] = mapped_column(String(100))
    os: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Location
    country: Mapped[Optional[str]] = mapped_column(String(100))
    city: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Duration (for sessions)
    duration_seconds: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Table Arguments
    __table_args__ = (
        Index('idx_activitylog_user', 'user_id', 'created_at'),
        Index('idx_activitylog_type', 'activity_type', 'created_at'),
        Index('idx_activitylog_session', 'session_id'),
        {'comment': 'User activity tracking'}
    )
    
    # Validators
    @validates('activity_type')
    def validate_activity_type(self, key, value):
        valid_types = [
            'login', 'logout', 'page_view', 'action',
            'download', 'upload', 'search', 'export'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Activity type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<ActivityLog(id={self.id}, user='{self.user_name}', activity='{self.activity_type}')>"

==================================================

FILE: admission.py
----------------------------------------
"""
Admission Model
Patient admission tracking and management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Admission(BaseModel):
    """
    Patient admission model
    """
    
    __tablename__ = "admissions"
    
    # Admission Details
    admission_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    admission_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    admission_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Doctor
    admitting_doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Location
    room_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("rooms.id", ondelete="SET NULL"),
        index=True
    )
    bed_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("beds.id", ondelete="SET NULL"),
        index=True
    )
    ward_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("wards.id", ondelete="SET NULL"),
        index=True
    )
    
    # Admission Type
    admission_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="emergency, planned, transfer, observation"
    )
    
    # Reason
    diagnosis: Mapped[str] = mapped_column(Text, nullable=False)
    symptoms: Mapped[Optional[str]] = mapped_column(Text)
    chief_complaint: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='admitted',
        nullable=False,
        index=True,
        comment="admitted, discharged, transferred, deceased"
    )
    
    # Discharge Information
    discharge_date: Mapped[Optional[str]] = mapped_column(String(20))
    discharge_time: Mapped[Optional[str]] = mapped_column(String(10))
    discharge_type: Mapped[Optional[str]] = mapped_column(
        String(50),
        comment="normal, against_medical_advice, transferred, deceased"
    )
    
    # Medical Details
    vital_signs: Mapped[Optional[str]] = mapped_column(Text, comment="JSON format")
    allergies: Mapped[Optional[str]] = mapped_column(Text)
    current_medications: Mapped[Optional[str]] = mapped_column(Text)
    
    # Treatment
    treatment_plan: Mapped[Optional[str]] = mapped_column(Text)
    special_instructions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Insurance
    insurance_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("insurances.id", ondelete="SET NULL")
    )
    insurance_approved: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Financial
    estimated_cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    advance_payment: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    
    # Notes
    admission_notes: Mapped[Optional[str]] = mapped_column(Text)
    discharge_summary: Mapped[Optional[str]] = mapped_column(Text)
    
    # Duration
    expected_duration_days: Mapped[Optional[int]] = mapped_column(Integer)
    actual_duration_days: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        back_populates="admissions"
    )
    
    admitting_doctor: Mapped["Doctor"] = relationship(
        "Doctor",
        backref="admissions"
    )
    
    room: Mapped[Optional["Room"]] = relationship(
        "Room",
        back_populates="admissions"
    )
    
    bed: Mapped[Optional["Bed"]] = relationship(
        "Bed",
        back_populates="admissions"
    )
    
    ward: Mapped[Optional["Ward"]] = relationship(
        "Ward",
        back_populates="admissions"
    )
    
    insurance: Mapped[Optional["Insurance"]] = relationship(
        "Insurance",
        backref="admissions"
    )
    
    discharge_record: Mapped[Optional["Discharge"]] = relationship(
        "Discharge",
        back_populates="admission",
        uselist=False
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('estimated_cost >= 0 OR estimated_cost IS NULL', name='admission_positive_estimated_cost'),
        CheckConstraint('advance_payment >= 0 OR advance_payment IS NULL', name='admission_positive_advance_payment'),
        CheckConstraint('expected_duration_days > 0 OR expected_duration_days IS NULL', name='admission_positive_expected_duration'),
        Index('idx_admission_patient', 'patient_id', 'status'),
        Index('idx_admission_doctor', 'admitting_doctor_id'),
        Index('idx_admission_date', 'admission_date', 'status'),
        Index('idx_admission_room_bed', 'room_id', 'bed_id'),
        {'comment': 'Patient admission records and tracking'}
    )
    
    # Validators
    @validates('admission_type')
    def validate_admission_type(self, key, value):
        valid_types = ['emergency', 'planned', 'transfer', 'observation', 'day_care']
        if value.lower() not in valid_types:
            raise ValueError(f"Admission type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['admitted', 'discharged', 'transferred', 'deceased', 'under_observation']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Admission(id={self.id}, number='{self.admission_number}', patient_id={self.patient_id}, status='{self.status}')>"
    

==================================================

FILE: ambulance.py
----------------------------------------
"""
Ambulance Model
Ambulance fleet and service management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal

from .base import BaseModel


class Ambulance(BaseModel):
    """
    Ambulance vehicle and service model
    """
    
    __tablename__ = "ambulances"
    
    # Vehicle Details
    ambulance_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    vehicle_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    vehicle_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="basic, advanced, air, mobile_icu, patient_transport"
    )
    
    # Vehicle Information
    manufacturer: Mapped[Optional[str]] = mapped_column(String(100))
    model: Mapped[Optional[str]] = mapped_column(String(100))
    year: Mapped[Optional[int]] = mapped_column(Integer)
    color: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Hospital
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="SET NULL"),
        index=True
    )
    
    # Driver Details
    driver_name: Mapped[Optional[str]] = mapped_column(String(200))
    driver_phone: Mapped[Optional[str]] = mapped_column(String(20))
    driver_license: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Equipment
    has_oxygen: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_ventilator: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_defibrillator: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_ecg: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_stretcher: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_wheelchair: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    
    # Capacity
    patient_capacity: Mapped[int] = mapped_column(Integer, default=1, nullable=False)
    staff_capacity: Mapped[int] = mapped_column(Integer, default=2, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='available',
        nullable=False,
        index=True,
        comment="available, on_duty, maintenance, out_of_service"
    )
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    
    # Current Location (for tracking)
    current_latitude: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 8))
    current_longitude: Mapped[Optional[Decimal]] = mapped_column(Numeric(11, 8))
    current_location: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Maintenance
    last_maintenance_date: Mapped[Optional[str]] = mapped_column(String(20))
    next_maintenance_date: Mapped[Optional[str]] = mapped_column(String(20))
    mileage: Mapped[Optional[int]] = mapped_column(Integer, comment="in kilometers")
    
    # Insurance
    insurance_number: Mapped[Optional[str]] = mapped_column(String(100))
    insurance_expiry: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Registration
    registration_number: Mapped[Optional[str]] = mapped_column(String(50))
    registration_expiry: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Cost
    fuel_type: Mapped[Optional[str]] = mapped_column(String(20), comment="petrol, diesel, cng, electric")
    base_charge: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    per_km_charge: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        backref="ambulances"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('patient_capacity > 0', name='ambulance_positive_patient_capacity'),
        CheckConstraint('staff_capacity >= 0', name='ambulance_positive_staff_capacity'),
        CheckConstraint('mileage >= 0 OR mileage IS NULL', name='ambulance_positive_mileage'),
        CheckConstraint('base_charge >= 0 OR base_charge IS NULL', name='ambulance_positive_base_charge'),
        CheckConstraint('per_km_charge >= 0 OR per_km_charge IS NULL', name='ambulance_positive_per_km_charge'),
        Index('idx_ambulance_hospital', 'hospital_id', 'status'),
        Index('idx_ambulance_availability', 'is_available', 'status'),
        {'comment': 'Ambulance fleet and service management'}
    )
    
    # Validators
    @validates('vehicle_type')
    def validate_vehicle_type(self, key, value):
        valid_types = ['basic', 'advanced', 'air', 'mobile_icu', 'patient_transport', 'neonatal']
        if value.lower() not in valid_types:
            raise ValueError(f"Vehicle type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['available', 'on_duty', 'maintenance', 'out_of_service', 'retired']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Ambulance(id={self.id}, number='{self.ambulance_number}', vehicle='{self.vehicle_number}', status='{self.status}')>"

==================================================

FILE: api_key.py
----------------------------------------
"""
API Key Model
API authentication and access management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class APIKey(BaseModel):
    """
    API Key model
    """
    
    __tablename__ = "api_keys"
    
    # Key Details
    key: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Owner
    owner_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    owner_type: Mapped[str] = mapped_column(String(50), nullable=False, comment="user, application, integration")
    
    # Permissions
    permissions: Mapped[str] = mapped_column(Text, nullable=False, comment="JSON array of allowed endpoints/actions")
    
    # IP Whitelist
    ip_whitelist: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of allowed IPs")
    
    # Rate Limiting
    rate_limit_per_minute: Mapped[int] = mapped_column(Integer, default=60)
    rate_limit_per_hour: Mapped[int] = mapped_column(Integer, default=1000)
    
    # Validity
    expires_at: Mapped[Optional[str]] = mapped_column(String(50), index=True)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, inactive, revoked, expired"
    )
    
    # Usage Stats
    total_requests: Mapped[int] = mapped_column(Integer, default=0)
    last_used_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Metadata
    metadata: Mapped[Optional[str]] = mapped_column(Text, comment="JSON additional data")
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('rate_limit_per_minute > 0', name='apikey_positive_rate_limit_minute'),
        CheckConstraint('rate_limit_per_hour > 0', name='apikey_positive_rate_limit_hour'),
        CheckConstraint('total_requests >= 0', name='apikey_positive_total_requests'),
        Index('idx_apikey_owner', 'owner_id', 'owner_type'),
        Index('idx_apikey_status', 'status', 'expires_at'),
        {'comment': 'API authentication and access management'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'inactive', 'revoked', 'expired']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<APIKey(id={self.id}, name='{self.name}', status='{self.status}')>"

==================================================

FILE: appointment.py
----------------------------------------
"""
Appointment Model
Patient appointment scheduling and management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, DateTime
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Appointment(BaseModel):
    """
    Appointment model for scheduling patient visits
    """
    
    __tablename__ = "appointments"
    
    # Appointment Details
    appointment_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    appointment_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    appointment_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Patient and Doctor
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    
    # Appointment Type
    appointment_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="consultation, follow_up, emergency, routine_checkup, diagnostic, vaccination"
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='scheduled',
        nullable=False,
        index=True,
        comment="scheduled, confirmed, in_progress, completed, cancelled, no_show, rescheduled"
    )
    
    # Duration
    duration_minutes: Mapped[int] = mapped_column(Integer, default=30, nullable=False)
    
    # Reason
    reason: Mapped[str] = mapped_column(Text, nullable=False)
    symptoms: Mapped[Optional[str]] = mapped_column(Text)
    
    # Notes
    doctor_notes: Mapped[Optional[str]] = mapped_column(Text)
    prescription_given: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Cancellation
    cancelled_by: Mapped[Optional[str]] = mapped_column(String(50))
    cancellation_reason: Mapped[Optional[str]] = mapped_column(Text)
    cancelled_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Rescheduling
    rescheduled_from: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("appointments.id", ondelete="SET NULL")
    )
    rescheduled_to: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Follow-up
    is_follow_up: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    parent_appointment_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("appointments.id", ondelete="SET NULL")
    )
    next_follow_up_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Payment
    consultation_fee: Mapped[Optional[float]] = mapped_column(Integer)
    payment_status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        comment="pending, paid, waived"
    )
    
    # Timestamps
    checked_in_at: Mapped[Optional[str]] = mapped_column(String(50))
    checked_out_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        back_populates="appointments"
    )
    
    doctor: Mapped["Doctor"] = relationship(
        "Doctor",
        back_populates="appointments"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        back_populates="appointments"
    )
    
    parent_appointment: Mapped[Optional["Appointment"]] = relationship(
        "Appointment",
        remote_side="Appointment.id",
        foreign_keys=[parent_appointment_id],
        backref="follow_up_appointments"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('duration_minutes > 0', name='appointment_positive_duration'),
        CheckConstraint('consultation_fee >= 0 OR consultation_fee IS NULL', name='appointment_positive_fee'),
        Index('idx_appointment_date_time', 'appointment_date', 'appointment_time'),
        Index('idx_appointment_patient', 'patient_id', 'status'),
        Index('idx_appointment_doctor', 'doctor_id', 'appointment_date'),
        Index('idx_appointment_status_date', 'status', 'appointment_date'),
        {'comment': 'Patient appointment scheduling and tracking'}
    )
    
    # Validators
    @validates('appointment_type')
    def validate_appointment_type(self, key, value):
        valid_types = [
            'consultation', 'follow_up', 'emergency', 'routine_checkup',
            'diagnostic', 'vaccination', 'therapy', 'counseling'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Appointment type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = [
            'scheduled', 'confirmed', 'in_progress', 'completed',
            'cancelled', 'no_show', 'rescheduled'
        ]
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('payment_status')
    def validate_payment_status(self, key, value):
        valid_statuses = ['pending', 'paid', 'waived', 'refunded']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Payment status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Appointment(id={self.id}, number='{self.appointment_number}', date='{self.appointment_date}', status='{self.status}')>"
    

==================================================

FILE: attendance.py
----------------------------------------
"""
Attendance Model
Staff attendance tracking and management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Time
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Attendance(BaseModel):
    """
    Staff attendance model
    """
    
    __tablename__ = "attendances"
    
    # Attendance Details
    attendance_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Staff Reference (can be doctor, nurse, or staff)
    staff_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="CASCADE"),
        index=True
    )
    doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        index=True
    )
    nurse_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("nurses.id", ondelete="CASCADE"),
        index=True
    )
    
    # Employee Info (denormalized for quick access)
    employee_name: Mapped[str] = mapped_column(String(200), nullable=False)
    employee_id: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    
    # Timing
    check_in_time: Mapped[Optional[str]] = mapped_column(String(10))
    check_out_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Work Hours
    scheduled_hours: Mapped[Optional[int]] = mapped_column(Integer, comment="in minutes")
    actual_hours: Mapped[Optional[int]] = mapped_column(Integer, comment="in minutes")
    overtime_hours: Mapped[Optional[int]] = mapped_column(Integer, default=0, comment="in minutes")
    
    # Shift
    shift_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("shifts.id", ondelete="SET NULL")
    )
    shift_name: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="present, absent, half_day, on_leave, late, early_departure, holiday"
    )
    
    # Late/Early
    is_late: Mapped[bool] = mapped_column(Boolean, default=False)
    late_by_minutes: Mapped[Optional[int]] = mapped_column(Integer)
    is_early_departure: Mapped[bool] = mapped_column(Boolean, default=False)
    early_by_minutes: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Location (if biometric/GPS based)
    check_in_location: Mapped[Optional[str]] = mapped_column(String(200))
    check_out_location: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Device/Method
    check_in_method: Mapped[Optional[str]] = mapped_column(String(50), comment="biometric, manual, rfid, mobile_app")
    check_out_method: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Break Time
    total_break_minutes: Mapped[Optional[int]] = mapped_column(Integer, default=0)
    
    # Approval
    approved_by: Mapped[Optional[str]] = mapped_column(String(200))
    approval_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    remarks: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    staff: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        back_populates="attendances"
    )
    
    doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="attendances"
    )
    
    nurse: Mapped[Optional["Nurse"]] = relationship(
        "Nurse",
        backref="attendances"
    )
    
    shift: Mapped[Optional["Shift"]] = relationship(
        "Shift",
        backref="attendances"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('overtime_hours >= 0', name='attendance_positive_overtime'),
        CheckConstraint('late_by_minutes >= 0 OR late_by_minutes IS NULL', name='attendance_positive_late_minutes'),
        CheckConstraint('early_by_minutes >= 0 OR early_by_minutes IS NULL', name='attendance_positive_early_minutes'),
        Index('idx_attendance_date', 'attendance_date', 'status'),
        Index('idx_attendance_employee', 'employee_id', 'attendance_date'),
        Index('idx_attendance_staff', 'staff_id', 'attendance_date'),
        Index('idx_attendance_doctor', 'doctor_id', 'attendance_date'),
        Index('idx_attendance_nurse', 'nurse_id', 'attendance_date'),
        {'comment': 'Staff attendance tracking and management'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = [
            'present', 'absent', 'half_day', 'on_leave',
            'late', 'early_departure', 'holiday', 'weekend'
        ]
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Attendance(id={self.id}, employee='{self.employee_name}', date='{self.attendance_date}', status='{self.status}')>"

==================================================

FILE: audit_log.py
----------------------------------------
"""
Audit Log Model
System audit trail and activity logging
"""

from sqlalchemy import Column, Integer, String, Text, Index
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class AuditLog(BaseModel):
    """
    Audit log model for tracking all system actions
    """
    
    __tablename__ = "audit_logs"
    
    # User/Actor
    user_id: Mapped[Optional[int]] = mapped_column(Integer, index=True)
    username: Mapped[Optional[str]] = mapped_column(String(200))
    user_type: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Action
    action: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="create, update, delete, login, logout, view, export, approve"
    )
    
    # Resource
    resource_type: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    resource_id: Mapped[Optional[int]] = mapped_column(Integer, index=True)
    resource_name: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Details
    description: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Changes (before/after)
    old_values: Mapped[Optional[str]] = mapped_column(Text, comment="JSON of old values")
    new_values: Mapped[Optional[str]] = mapped_column(Text, comment="JSON of new values")
    
    # Request Details
    ip_address: Mapped[Optional[str]] = mapped_column(String(50))
    user_agent: Mapped[Optional[str]] = mapped_column(String(500))
    request_method: Mapped[Optional[str]] = mapped_column(String(10))
    request_path: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='success',
        nullable=False,
        comment="success, failure, error"
    )
    
    # Error Details (if any)
    error_message: Mapped[Optional[str]] = mapped_column(Text)
    
    # Timestamp (inherited from BaseModel, but we index it)
    
    # Table Arguments
    __table_args__ = (
        Index('idx_auditlog_user', 'user_id', 'created_at'),
        Index('idx_auditlog_resource', 'resource_type', 'resource_id'),
        Index('idx_auditlog_action', 'action', 'created_at'),
        Index('idx_auditlog_timestamp', 'created_at'),
        {'comment': 'System audit trail and activity logging'}
    )
    
    # Validators
    @validates('action')
    def validate_action(self, key, value):
        valid_actions = [
            'create', 'update', 'delete', 'login', 'logout',
            'view', 'export', 'approve', 'reject', 'send'
        ]
        if value.lower() not in valid_actions:
            raise ValueError(f"Action must be one of: {', '.join(valid_actions)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['success', 'failure', 'error']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<AuditLog(id={self.id}, action='{self.action}', resource='{self.resource_type}')>"

==================================================

FILE: base.py
----------------------------------------
"""
Base models and mixins for SQLAlchemy 2.0
Provides common fields and functionality for all models
"""

from datetime import datetime
from typing import Any
from sqlalchemy import Column, Integer, DateTime, Boolean, func, event
from sqlalchemy.orm import declared_attr, DeclarativeBase, Mapped, mapped_column
from sqlalchemy.ext.declarative import declarative_base


# ============================================
# Mixins
# ============================================

class TimestampMixin:
    """Mixin for created_at and updated_at timestamps"""
    
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        nullable=False,
        index=True
    )
    
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now(),
        nullable=False
    )


class SoftDeleteMixin:
    """Mixin for soft delete functionality"""
    
    is_deleted: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, index=True)
    deleted_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    
    def soft_delete(self) -> None:
        """Mark record as deleted"""
        self.is_deleted = True
        self.deleted_at = datetime.utcnow()
    
    def restore(self) -> None:
        """Restore soft-deleted record"""
        self.is_deleted = False
        self.deleted_at = None


class ActiveMixin:
    """Mixin for is_active flag"""
    
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    
    def activate(self) -> None:
        """Activate record"""
        self.is_active = True
    
    def deactivate(self) -> None:
        """Deactivate record"""
        self.is_active = False


# ============================================
# Base Model
# ============================================

class BaseModel(TimestampMixin, SoftDeleteMixin, ActiveMixin):
    """
    Base model with common fields for all models
    Includes: id, timestamps, soft delete, active flag
    """
    
    __abstract__ = True
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True, index=True, autoincrement=True)
    
    @declared_attr
    def __tablename__(cls) -> str:
        """Generate table name from class name"""
        return cls.__name__.lower() + 's'
    
    def to_dict(self) -> dict[str, Any]:
        """
        Convert model to dictionary
        
        Returns:
            Dictionary representation of model
        """
        return {
            column.name: getattr(self, column.name)
            for column in self.__table__.columns
        }
    
    def update(self, **kwargs) -> None:
        """
        Update model attributes
        
        Args:
            **kwargs: Attributes to update
        """
        for key, value in kwargs.items():
            if hasattr(self, key):
                setattr(self, key, value)
    
    def __repr__(self) -> str:
        """String representation"""
        attrs = ", ".join(
            f"{col.name}={getattr(self, col.name)!r}"
            for col in self.__table__.columns
            if col.name in ['id', 'name'] or col.primary_key
        )
        return f"<{self.__class__.__name__}({attrs})>"


# ============================================
# Event Listeners
# ============================================

@event.listens_for(BaseModel, 'before_update', propagate=True)
def receive_before_update(mapper, connection, target):
    """Update timestamp before update"""
    target.updated_at = datetime.utcnow()


@event.listens_for(BaseModel, 'before_insert', propagate=True)
def receive_before_insert(mapper, connection, target):
    """Set timestamps before insert"""
    now = datetime.utcnow()
    target.created_at = now
    target.updated_at = now


# ============================================
# Exports
# ============================================

__all__ = [
    "BaseModel",
    "TimestampMixin",
    "SoftDeleteMixin",
    "ActiveMixin",
]


==================================================

FILE: bed.py
----------------------------------------
"""
Bed Model
Individual bed management within rooms
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Bed(BaseModel):
    """
    Bed model for individual bed tracking
    """
    
    __tablename__ = "beds"
    
    # Basic Information
    bed_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    bed_code: Mapped[Optional[str]] = mapped_column(String(20), unique=True, index=True)
    
    # Location
    room_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("rooms.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    ward_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("wards.id", ondelete="SET NULL"),
        index=True
    )
    
    # Bed Type
    bed_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="general, icu, electric, manual, pediatric, maternity, bariatric"
    )
    
    # Specifications
    is_electric: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_side_rails: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    is_adjustable: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    weight_capacity_kg: Mapped[Optional[Decimal]] = mapped_column(Numeric(6, 2))
    
    # Equipment
    has_iv_stand: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_oxygen_port: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_suction_port: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_monitor: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='available',
        nullable=False,
        index=True,
        comment="available, occupied, maintenance, reserved, cleaning"
    )
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    
    # Current Assignment
    current_patient_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="SET NULL"),
        index=True
    )
    assigned_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Maintenance
    last_maintenance_date: Mapped[Optional[str]] = mapped_column(String(50))
    next_maintenance_date: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Additional Info
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    room: Mapped["Room"] = relationship(
        "Room",
        back_populates="beds"
    )
    
    ward: Mapped[Optional["Ward"]] = relationship(
        "Ward",
        back_populates="beds"
    )
    
    current_patient: Mapped[Optional["Patient"]] = relationship(
        "Patient",
        back_populates="current_bed",
        foreign_keys=[current_patient_id]
    )
    
    admissions: Mapped[List["Admission"]] = relationship(
        "Admission",
        back_populates="bed",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('weight_capacity_kg > 0 OR weight_capacity_kg IS NULL', name='bed_positive_weight_capacity'),
        Index('idx_bed_room', 'room_id', 'status'),
        Index('idx_bed_ward', 'ward_id', 'status'),
        Index('idx_bed_availability', 'is_available', 'status'),
        Index('idx_bed_patient', 'current_patient_id'),
        {'comment': 'Individual bed tracking and management'}
    )
    
    # Validators
    @validates('bed_type')
    def validate_bed_type(self, key, value):
        """Validate bed type"""
        valid_types = [
            'general', 'icu', 'electric', 'manual', 'pediatric',
            'maternity', 'bariatric', 'orthopedic', 'psychiatric'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Bed type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['available', 'occupied', 'maintenance', 'reserved', 'cleaning', 'out_of_service']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    # Methods
    def assign_patient(self, patient_id: int) -> None:
        """Assign bed to patient"""
        from datetime import datetime
        self.current_patient_id = patient_id
        self.status = 'occupied'
        self.is_available = False
        self.assigned_at = datetime.utcnow().isoformat()
    
    def release_bed(self) -> None:
        """Release bed from patient"""
        self.current_patient_id = None
        self.status = 'available'
        self.is_available = True
        self.assigned_at = None
    
    def __repr__(self) -> str:
        return f"<Bed(id={self.id}, number='{self.bed_number}', status='{self.status}')>"


==================================================

FILE: billing.py
----------------------------------------
"""
Billing Model
Patient billing and invoice management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal

from .base import BaseModel


class Billing(BaseModel):
    """
    Patient billing and invoice model
    """
    
    __tablename__ = "billings"
    
    # Invoice Details
    invoice_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    invoice_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Related Records
    admission_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("admissions.id", ondelete="SET NULL"),
        index=True
    )
    appointment_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("appointments.id", ondelete="SET NULL")
    )
    
    # Bill Type
    bill_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="outpatient, inpatient, emergency, diagnostic, pharmacy, procedure"
    )
    
    # Items (JSON format)
    bill_items: Mapped[str] = mapped_column(Text, nullable=False, comment="JSON array of billing items")
    
    # Financial Details
    subtotal: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    discount_percentage: Mapped[Decimal] = mapped_column(Numeric(5, 2), default=Decimal('0.00'))
    discount_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    tax_percentage: Mapped[Decimal] = mapped_column(Numeric(5, 2), default=Decimal('0.00'))
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    total_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Payment Status
    payment_status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, partial, paid, overdue, cancelled"
    )
    amount_paid: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    amount_due: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Insurance
    insurance_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("insurances.id", ondelete="SET NULL")
    )
    insurance_claim_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    insurance_approved_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    insurance_status: Mapped[Optional[str]] = mapped_column(
        String(20),
        comment="pending, approved, rejected, partially_approved"
    )
    
    # Due Date
    due_date: Mapped[Optional[str]] = mapped_column(String(20), index=True)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, cancelled, refunded, void"
    )
    
    # Generated By
    generated_by: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    terms_conditions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        back_populates="billings"
    )
    
    admission: Mapped[Optional["Admission"]] = relationship(
        "Admission",
        backref="billings"
    )
    
    appointment: Mapped[Optional["Appointment"]] = relationship(
        "Appointment",
        backref="billings"
    )
    
    insurance: Mapped[Optional["Insurance"]] = relationship(
        "Insurance",
        backref="billings"
    )
    
    payments: Mapped[List["Payment"]] = relationship(
        "Payment",
        back_populates="billing",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('subtotal >= 0', name='billing_positive_subtotal'),
        CheckConstraint('discount_amount >= 0', name='billing_positive_discount'),
        CheckConstraint('tax_amount >= 0', name='billing_positive_tax'),
        CheckConstraint('total_amount >= 0', name='billing_positive_total'),
        CheckConstraint('amount_paid >= 0', name='billing_positive_paid'),
        CheckConstraint('amount_due >= 0', name='billing_positive_due'),
        Index('idx_billing_patient', 'patient_id', 'invoice_date'),
        Index('idx_billing_payment_status', 'payment_status', 'status'),
        Index('idx_billing_due_date', 'due_date', 'payment_status'),
        {'comment': 'Patient billing and invoice management'}
    )
    
    # Validators
    @validates('bill_type')
    def validate_bill_type(self, key, value):
        valid_types = [
            'outpatient', 'inpatient', 'emergency', 'diagnostic',
            'pharmacy', 'procedure', 'surgery', 'lab'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Bill type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('payment_status')
    def validate_payment_status(self, key, value):
        valid_statuses = ['pending', 'partial', 'paid', 'overdue', 'cancelled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Payment status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'cancelled', 'refunded', 'void']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @property
    def is_overdue(self) -> bool:
        """Check if payment is overdue"""
        from datetime import datetime
        if self.due_date and self.payment_status != 'paid':
            try:
                due = datetime.strptime(self.due_date, '%Y-%m-%d')
                return datetime.now() > due
            except:
                return False
        return False
    
    def __repr__(self) -> str:
        return f"<Billing(id={self.id}, invoice='{self.invoice_number}', amount={self.total_amount}, status='{self.payment_status}')>"

==================================================

FILE: branch.py
----------------------------------------
"""
Branch Model
Hospital branch locations
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Branch(BaseModel):
    """
    Hospital branch model
    Manages multiple locations of the same hospital
    """
    
    __tablename__ = "branches"
    
    # Basic Information
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Hospital Reference
    hospital_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Location
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Contact
    phone: Mapped[Optional[str]] = mapped_column(String(20))
    email: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Building Details
    total_floors: Mapped[int] = mapped_column(Integer, default=1, nullable=False)
    basement_floors: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Capacity
    total_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_rooms: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(String(20), default='active', index=True)
    is_main_branch: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Additional Info
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    hospital: Mapped["Hospital"] = relationship(
        "Hospital",
        back_populates="branches"
    )
    
    floors: Mapped[List["Floor"]] = relationship(
        "Floor",
        back_populates="branch",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    departments: Mapped[List["Department"]] = relationship(
        "Department",
        back_populates="branch",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_floors >= 1', name='branch_min_one_floor'),
        Index('idx_branch_hospital', 'hospital_id', 'status'),
        {'comment': 'Hospital branch locations'}
    )
    
    def __repr__(self) -> str:
        return f"<Branch(id={self.id}, name='{self.name}', code='{self.code}')>"
    


==================================================

FILE: chat.py
----------------------------------------
"""
Chat Model
Real-time chat messaging
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Chat(BaseModel):
    """
    Real-time chat model
    """
    
    __tablename__ = "chats"
    
    # Room/Channel
    room_id: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    room_name: Mapped[Optional[str]] = mapped_column(String(200))
    room_type: Mapped[str] = mapped_column(
        String(20),
        default='direct',
        nullable=False,
        comment="direct, group, support, emergency"
    )
    
    # Sender
    sender_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    sender_name: Mapped[str] = mapped_column(String(200), nullable=False)
    sender_type: Mapped[str] = mapped_column(String(20))
    
    # Message
    message: Mapped[str] = mapped_column(Text, nullable=False)
    message_type: Mapped[str] = mapped_column(
        String(20),
        default='text',
        nullable=False,
        comment="text, image, file, audio, video, location"
    )
    
    # Attachments
    attachment_url: Mapped[Optional[str]] = mapped_column(String(500))
    attachment_type: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Status
    is_read: Mapped[bool] = mapped_column(Boolean, default=False)
    read_by: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of user IDs who read")
    
    # Reply To
    reply_to_message_id: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Reactions
    reactions: Mapped[Optional[str]] = mapped_column(Text, comment="JSON object of reactions")
    
    # Edit
    is_edited: Mapped[bool] = mapped_column(Boolean, default=False)
    edited_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Delete
    is_deleted: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Table Arguments
    __table_args__ = (
        Index('idx_chat_room', 'room_id', 'created_at'),
        Index('idx_chat_sender', 'sender_id', 'created_at'),
        {'comment': 'Real-time chat messaging'}
    )
    
    # Validators
    @validates('room_type')
    def validate_room_type(self, key, value):
        valid_types = ['direct', 'group', 'support', 'emergency', 'announcement']
        if value.lower() not in valid_types:
            raise ValueError(f"Room type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('message_type')
    def validate_message_type(self, key, value):
        valid_types = ['text', 'image', 'file', 'audio', 'video', 'location']
        if value.lower() not in valid_types:
            raise ValueError(f"Message type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Chat(id={self.id}, room='{self.room_id}', sender='{self.sender_name}')>"

==================================================

FILE: complaint.py
----------------------------------------
"""
Complaint Model
Patient and staff complaints/grievances
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Complaint(BaseModel):
    """
    Complaint/Grievance model
    """
    
    __tablename__ = "complaints"
    
    # Complaint Details
    complaint_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    title: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    description: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Complainant
    complainant_name: Mapped[str] = mapped_column(String(200), nullable=False)
    complainant_email: Mapped[Optional[str]] = mapped_column(String(100))
    complainant_phone: Mapped[str] = mapped_column(String(20), nullable=False)
    complainant_type: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        comment="patient, visitor, staff, doctor, vendor"
    )
    
    # Patient Reference (if applicable)
    patient_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="SET NULL"),
        index=True
    )
    
    # Category
    category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="medical_care, staff_behavior, facility, billing, administration, hygiene, food"
    )
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL")
    )
    
    # Severity
    severity: Mapped[str] = mapped_column(
        String(20),
        default='medium',
        nullable=False,
        comment="low, medium, high, critical"
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='open',
        nullable=False,
        index=True,
        comment="open, in_progress, resolved, closed, rejected"
    )
    
    # Dates
    incident_date: Mapped[Optional[str]] = mapped_column(String(20))
    filed_date: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Assignment
    assigned_to: Mapped[Optional[str]] = mapped_column(String(200))
    assigned_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Resolution
    resolution: Mapped[Optional[str]] = mapped_column(Text)
    resolved_by: Mapped[Optional[str]] = mapped_column(String(200))
    resolved_date: Mapped[Optional[str]] = mapped_column(String(20))
    resolution_time_hours: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Follow-up
    requires_followup: Mapped[bool] = mapped_column(Boolean, default=False)
    followup_date: Mapped[Optional[str]] = mapped_column(String(20))
    followup_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Satisfaction
    is_satisfied: Mapped[Optional[bool]] = mapped_column(Boolean)
    satisfaction_rating: Mapped[Optional[int]] = mapped_column(Integer)
    satisfaction_comments: Mapped[Optional[str]] = mapped_column(Text)
    
    # Attachments
    attachments: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of attachment URLs")
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    internal_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped[Optional["Patient"]] = relationship(
        "Patient",
        backref="complaints"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="complaints"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('satisfaction_rating >= 1 AND satisfaction_rating <= 5 OR satisfaction_rating IS NULL', name='complaint_valid_rating'),
        Index('idx_complaint_category', 'category', 'status'),
        Index('idx_complaint_status', 'status', 'severity'),
        Index('idx_complaint_filed_date', 'filed_date', 'status'),
        {'comment': 'Patient and staff complaints/grievances'}
    )
    
    # Validators
    @validates('category')
    def validate_category(self, key, value):
        valid_categories = [
            'medical_care', 'staff_behavior', 'facility', 'billing',
            'administration', 'hygiene', 'food', 'waiting_time', 'communication'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('severity')
    def validate_severity(self, key, value):
        valid_severities = ['low', 'medium', 'high', 'critical']
        if value.lower() not in valid_severities:
            raise ValueError(f"Severity must be one of: {', '.join(valid_severities)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['open', 'in_progress', 'resolved', 'closed', 'rejected']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Complaint(id={self.id}, number='{self.complaint_number}', status='{self.status}')>"

==================================================

FILE: department.py
----------------------------------------
"""
Department Model - Updated with Floor Reference
Hospital departments with floor location
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Department(BaseModel):
    """
    Department model with floor reference
    Manages hospital departments across different floors
    """
    
    __tablename__ = "departments"
    
    # Basic Information
    name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Department Type
    department_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="clinical, diagnostic, support, administrative"
    )
    
    #  Floor Reference - NEW
    main_floor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("floors.id", ondelete="SET NULL"),
        nullable=True,
        index=True
    )
    main_floor_number: Mapped[Optional[int]] = mapped_column(Integer, nullable=True, index=True)
    
    # Location
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="CASCADE"),
        index=True
    )
    branch_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("branches.id", ondelete="CASCADE"),
        index=True
    )
    building: Mapped[Optional[str]] = mapped_column(String(50))
    wing: Mapped[Optional[str]] = mapped_column(String(50), comment="East, West, North, South")
    
    # Management
    head_doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    
    # Contact
    contact_number: Mapped[Optional[str]] = mapped_column(String(20))
    email: Mapped[Optional[str]] = mapped_column(String(100))
    extension: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Staff Count
    total_doctors: Mapped[int] = mapped_column(Integer, default=0)
    total_nurses: Mapped[int] = mapped_column(Integer, default=0)
    total_staff: Mapped[int] = mapped_column(Integer, default=0)
    
    # Facilities
    total_rooms: Mapped[int] = mapped_column(Integer, default=0)
    total_beds: Mapped[int] = mapped_column(Integer, default=0)
    
    # Status
    status: Mapped[str] = mapped_column(String(20), default='active', index=True)
    is_emergency_department: Mapped[bool] = mapped_column(Boolean, default=False)
    is_24x7: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Additional Info
    description: Mapped[Optional[str]] = mapped_column(Text)
    services_offered: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    main_floor: Mapped[Optional["Floor"]] = relationship(
        "Floor",
        back_populates="departments",
        foreign_keys=[main_floor_id]
    )
    
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        back_populates="departments"
    )
    
    branch: Mapped[Optional["Branch"]] = relationship(
        "Branch",
        back_populates="departments"
    )
    
    head_doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        back_populates="departments_managed",
        foreign_keys=[head_doctor_id]
    )
    
    doctors: Mapped[List["Doctor"]] = relationship(
        "Doctor",
        back_populates="department",
        foreign_keys="Doctor.department_id",
        lazy="dynamic"
    )
    
    nurses: Mapped[List["Nurse"]] = relationship(
        "Nurse",
        back_populates="department",
        lazy="dynamic"
    )
    
    rooms: Mapped[List["Room"]] = relationship(
        "Room",
        back_populates="department",
        lazy="dynamic"
    )
    
    wards: Mapped[List["Ward"]] = relationship(
        "Ward",
        back_populates="department",
        lazy="dynamic"
    )
    
    appointments: Mapped[List["Appointment"]] = relationship(
        "Appointment",
        back_populates="department",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_doctors >= 0', name='dept_positive_doctors'),
        CheckConstraint('total_nurses >= 0', name='dept_positive_nurses'),
        Index('idx_department_floor', 'main_floor_id', 'main_floor_number'),
        Index('idx_department_hospital', 'hospital_id', 'status'),
        Index('idx_department_type', 'department_type', 'status'),
        {'comment': 'Hospital departments with floor locations'}
    )
    
    # Validators
    @validates('department_type')
    def validate_department_type(self, key, value):
        """Validate department type"""
        valid_types = [
            'clinical', 'diagnostic', 'support', 'administrative',
            'emergency', 'surgical', 'medical', 'pediatric'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Department type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    def __repr__(self) -> str:
        floor_info = f", floor={self.main_floor_number}" if self.main_floor_number is not None else ""
        return f"<Department(id={self.id}, name='{self.name}'{floor_info})>"


==================================================

FILE: diagnosis.py
----------------------------------------
"""
 Diagnosis model
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Diagnosis(Base):
    __tablename__ = "diagnoses"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    doctor_id = Column(Integer, ForeignKey("doctors.id", ondelete="CASCADE"), nullable=False)
    description = Column(String, nullable=False)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    #  Relationships
    patient = relationship("Patient", back_populates="diagnoses")
    doctor = relationship("Doctor", back_populates="diagnoses")

==================================================

FILE: discharge.py
----------------------------------------
"""
Discharge Model
Patient discharge records
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Discharge(BaseModel):
    """
    Patient discharge record model
    """
    
    __tablename__ = "discharges"
    
    # Discharge Details
    discharge_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    discharge_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    discharge_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # References
    admission_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("admissions.id", ondelete="CASCADE"),
        unique=True,
        nullable=False,
        index=True
    )
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    discharging_doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False
    )
    
    # Discharge Type
    discharge_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="normal, against_medical_advice, transferred, deceased, absconded"
    )
    
    # Medical Summary
    final_diagnosis: Mapped[str] = mapped_column(Text, nullable=False)
    treatment_summary: Mapped[str] = mapped_column(Text, nullable=False)
    procedures_performed: Mapped[Optional[str]] = mapped_column(Text)
    complications: Mapped[Optional[str]] = mapped_column(Text)
    
    # Condition at Discharge
    condition_at_discharge: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="improved, stable, deteriorated, critical, expired"
    )
    
    # Follow-up
    follow_up_required: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    follow_up_date: Mapped[Optional[str]] = mapped_column(String(20))
    follow_up_doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    follow_up_instructions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Medications
    discharge_medications: Mapped[Optional[str]] = mapped_column(Text)
    medication_instructions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Instructions
    diet_instructions: Mapped[Optional[str]] = mapped_column(Text)
    activity_restrictions: Mapped[Optional[str]] = mapped_column(Text)
    general_instructions: Mapped[Optional[str]] = mapped_column(Text)
    warning_signs: Mapped[Optional[str]] = mapped_column(Text)
    
    # Documents
    discharge_summary_url: Mapped[Optional[str]] = mapped_column(String(500))
    medical_certificate_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Transfer Details (if applicable)
    transferred_to_facility: Mapped[Optional[str]] = mapped_column(String(200))
    transfer_reason: Mapped[Optional[str]] = mapped_column(Text)
    
    # Death Details (if applicable)
    death_time: Mapped[Optional[str]] = mapped_column(String(10))
    cause_of_death: Mapped[Optional[str]] = mapped_column(Text)
    death_certificate_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Notes
    discharge_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    admission: Mapped["Admission"] = relationship(
        "Admission",
        back_populates="discharge_record"
    )
    
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="discharge_records"
    )
    
    discharging_doctor: Mapped["Doctor"] = relationship(
        "Doctor",
        foreign_keys=[discharging_doctor_id],
        backref="discharges_performed"
    )
    
    follow_up_doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        foreign_keys=[follow_up_doctor_id],
        backref="follow_up_discharges"
    )
    
    # Table Arguments
    __table_args__ = (
        Index('idx_discharge_patient', 'patient_id', 'discharge_date'),
        Index('idx_discharge_admission', 'admission_id'),
        Index('idx_discharge_type', 'discharge_type'),
        {'comment': 'Patient discharge records and summaries'}
    )
    
    # Validators
    @validates('discharge_type')
    def validate_discharge_type(self, key, value):
        valid_types = [
            'normal', 'against_medical_advice', 'transferred',
            'deceased', 'absconded', 'referred'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Discharge type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('condition_at_discharge')
    def validate_condition(self, key, value):
        valid_conditions = ['improved', 'stable', 'deteriorated', 'critical', 'expired', 'recovered']
        if value.lower() not in valid_conditions:
            raise ValueError(f"Condition must be one of: {', '.join(valid_conditions)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Discharge(id={self.id}, number='{self.discharge_number}', patient_id={self.patient_id})>"

==================================================

FILE: doctor.py
----------------------------------------
"""
Doctor Model
Medical staff information and specializations
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal
import re

from .base import BaseModel


class Doctor(BaseModel):
    """
    Doctor model for medical staff management
    """
    
    __tablename__ = "doctors"
    
    # User Reference
    user_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("users.id", ondelete="CASCADE"),
        unique=True,
        index=True
    )
    
    # Basic Information
    doctor_id: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    first_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    middle_name: Mapped[Optional[str]] = mapped_column(String(100))
    last_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    
    # Professional Information
    specialization: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    qualification: Mapped[str] = mapped_column(String(200), nullable=False)
    medical_license_number: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    license_expiry_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Experience
    years_of_experience: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    previous_hospitals: Mapped[Optional[str]] = mapped_column(Text)
    
    # Contact Information
    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    phone: Mapped[str] = mapped_column(String(20), nullable=False)
    alternate_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Hospital Assignment
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="SET NULL"),
        index=True
    )
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    
    # Professional Details
    designation: Mapped[Optional[str]] = mapped_column(String(100))
    employee_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True, index=True)
    joining_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Consultation
    consultation_fee: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    average_consultation_time: Mapped[int] = mapped_column(Integer, default=30, comment="minutes")
    
    # Availability
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    is_on_duty: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    max_appointments_per_day: Mapped[int] = mapped_column(Integer, default=20, nullable=False)
    
    # Ratings
    rating: Mapped[Optional[Decimal]] = mapped_column(Numeric(3, 2))
    total_ratings: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, on_leave, resigned, retired, suspended"
    )
    
    # Emergency Contact
    emergency_contact_name: Mapped[Optional[str]] = mapped_column(String(200))
    emergency_contact_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Additional Information
    bio: Mapped[Optional[str]] = mapped_column(Text)
    languages_spoken: Mapped[Optional[str]] = mapped_column(String(200))
    awards_achievements: Mapped[Optional[str]] = mapped_column(Text)
    research_publications: Mapped[Optional[str]] = mapped_column(Text)
    profile_image: Mapped[Optional[str]] = mapped_column(String(500))
    signature_image: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        back_populates="doctors"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        back_populates="doctors",
        foreign_keys=[department_id]
    )
    
    departments_managed: Mapped[List["Department"]] = relationship(
        "Department",
        back_populates="head_doctor",
        foreign_keys="Department.head_doctor_id",
        lazy="dynamic"
    )
    
    patients: Mapped[List["Patient"]] = relationship(
        "Patient",
        back_populates="primary_doctor",
        lazy="dynamic"
    )
    
    appointments: Mapped[List["Appointment"]] = relationship(
        "Appointment",
        back_populates="doctor",
        lazy="dynamic"
    )
    
    prescriptions: Mapped[List["Prescription"]] = relationship(
        "Prescription",
        back_populates="doctor",
        lazy="dynamic"
    )
    
    schedules: Mapped[List["Schedule"]] = relationship(
        "Schedule",
        back_populates="doctor",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('years_of_experience >= 0', name='doctor_positive_experience'),
        CheckConstraint('consultation_fee >= 0 OR consultation_fee IS NULL', name='doctor_positive_fee'),
        CheckConstraint('rating >= 0 AND rating <= 5 OR rating IS NULL', name='doctor_valid_rating'),
        CheckConstraint('average_consultation_time > 0', name='doctor_positive_consultation_time'),
        CheckConstraint('max_appointments_per_day > 0', name='doctor_positive_max_appointments'),
        Index('idx_doctor_name', 'first_name', 'last_name'),
        Index('idx_doctor_specialization', 'specialization', 'status'),
        Index('idx_doctor_hospital', 'hospital_id', 'status'),
        Index('idx_doctor_department', 'department_id', 'status'),
        Index('idx_doctor_availability', 'is_available', 'is_on_duty'),
        {'comment': 'Medical staff information and credentials'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        """Validate email format"""
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['active', 'on_leave', 'resigned', 'retired', 'suspended', 'inactive']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    # Properties
    @property
    def full_name(self) -> str:
        """Get full name with title"""
        name = f"Dr. {self.first_name}"
        if self.middle_name:
            name += f" {self.middle_name}"
        name += f" {self.last_name}"
        return name
    
    @property
    def average_rating(self) -> float:
        """Get average rating"""
        if self.rating:
            return float(self.rating)
        return 0.0
    
    def __repr__(self) -> str:
        return f"<Doctor(id={self.id}, doctor_id='{self.doctor_id}', name='{self.full_name}', specialization='{self.specialization}')>"


==================================================

FILE: emergency.py
----------------------------------------
"""
Emergency Model
Emergency department cases and tracking
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Emergency(BaseModel):
    """
    Emergency case model
    """
    
    __tablename__ = "emergencies"
    
    # Emergency Details
    emergency_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    arrival_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    arrival_time: Mapped[str] = mapped_column(String(10), nullable=False)
    arrival_mode: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="ambulance, walk_in, police, transferred"
    )
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Attending Doctor
    attending_doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL"),
        index=True
    )
    
    # Triage
    triage_category: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="critical, urgent, semi_urgent, non_urgent, deceased"
    )
    triage_color: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        comment="red, orange, yellow, green, blue, black"
    )
    triage_time: Mapped[Optional[str]] = mapped_column(String(10))
    triaged_by: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Chief Complaint
    chief_complaint: Mapped[str] = mapped_column(Text, nullable=False)
    symptoms: Mapped[Optional[str]] = mapped_column(Text)
    
    # Vital Signs
    temperature: Mapped[Optional[str]] = mapped_column(String(10))
    blood_pressure: Mapped[Optional[str]] = mapped_column(String(20))
    pulse_rate: Mapped[Optional[str]] = mapped_column(String(10))
    respiratory_rate: Mapped[Optional[str]] = mapped_column(String(10))
    oxygen_saturation: Mapped[Optional[str]] = mapped_column(String(10))
    glasgow_coma_scale: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Medical History (at time of arrival)
    known_allergies: Mapped[Optional[str]] = mapped_column(Text)
    current_medications: Mapped[Optional[str]] = mapped_column(Text)
    medical_history: Mapped[Optional[str]] = mapped_column(Text)
    
    # Treatment
    initial_treatment: Mapped[Optional[str]] = mapped_column(Text)
    investigations_ordered: Mapped[Optional[str]] = mapped_column(Text)
    diagnosis: Mapped[Optional[str]] = mapped_column(Text)
    
    # Outcome
    disposition: Mapped[str] = mapped_column(
        String(50),
        default='under_observation',
        nullable=False,
        index=True,
        comment="admitted, discharged, transferred, deceased, left_against_advice, absconded"
    )
    disposition_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # If Admitted
    admitted_to_ward_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("wards.id", ondelete="SET NULL")
    )
    admission_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("admissions.id", ondelete="SET NULL")
    )
    
    # If Transferred
    transferred_to: Mapped[Optional[str]] = mapped_column(String(200))
    transfer_reason: Mapped[Optional[str]] = mapped_column(Text)
    
    # Ambulance (if arrived by ambulance)
    ambulance_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("ambulances.id", ondelete="SET NULL")
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='in_progress',
        nullable=False,
        index=True,
        comment="in_progress, completed, cancelled"
    )
    
    # Police Case
    is_police_case: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    police_station: Mapped[Optional[str]] = mapped_column(String(200))
    fir_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Medico-Legal Case
    is_mlc: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    mlc_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Time Tracking
    door_to_doctor_time: Mapped[Optional[int]] = mapped_column(Integer, comment="minutes")
    total_time_in_er: Mapped[Optional[int]] = mapped_column(Integer, comment="minutes")
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="emergency_visits"
    )
    
    attending_doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="emergency_cases"
    )
    
    ward: Mapped[Optional["Ward"]] = relationship(
        "Ward",
        backref="emergency_admissions"
    )
    
    admission: Mapped[Optional["Admission"]] = relationship(
        "Admission",
        backref="emergency_record"
    )
    
    ambulance: Mapped[Optional["Ambulance"]] = relationship(
        "Ambulance",
        backref="emergency_cases"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('glasgow_coma_scale >= 3 AND glasgow_coma_scale <= 15 OR glasgow_coma_scale IS NULL', name='emergency_valid_gcs'),
        Index('idx_emergency_patient', 'patient_id', 'arrival_date'),
        Index('idx_emergency_triage', 'triage_category', 'status'),
        Index('idx_emergency_disposition', 'disposition', 'status'),
        {'comment': 'Emergency department cases and patient tracking'}
    )
    
    # Validators
    @validates('triage_category')
    def validate_triage_category(self, key, value):
        valid_categories = ['critical', 'urgent', 'semi_urgent', 'non_urgent', 'deceased']
        if value.lower() not in valid_categories:
            raise ValueError(f"Triage category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('disposition')
    def validate_disposition(self, key, value):
        valid_dispositions = [
            'admitted', 'discharged', 'transferred', 'deceased',
            'left_against_advice', 'absconded', 'under_observation'
        ]
        if value.lower() not in valid_dispositions:
            raise ValueError(f"Disposition must be one of: {', '.join(valid_dispositions)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['in_progress', 'completed', 'cancelled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Emergency(id={self.id}, number='{self.emergency_number}', triage='{self.triage_category}')>"

==================================================

FILE: equipment.py
----------------------------------------
"""
Equipment Model
Medical equipment and asset tracking with floor location
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric, Date
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Equipment(BaseModel):
    """
    Medical equipment and assets model with floor tracking
    """
    
    __tablename__ = "equipments"
    
    # Equipment Details
    equipment_id: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    equipment_type: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="diagnostic, surgical, monitoring, life_support, imaging, laboratory"
    )
    
    # Category
    category: Mapped[str] = mapped_column(String(100), nullable=False)
    subcategory: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Manufacturer Details
    manufacturer: Mapped[str] = mapped_column(String(200), nullable=False)
    model_number: Mapped[str] = mapped_column(String(100), nullable=False)
    serial_number: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    
    # Purchase Details
    purchase_date: Mapped[Optional[str]] = mapped_column(String(20))
    purchase_price: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    supplier: Mapped[Optional[str]] = mapped_column(String(200))
    warranty_expiry_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    #  Location - Floor Reference
    floor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("floors.id", ondelete="SET NULL"),
        index=True
    )
    floor_number: Mapped[Optional[int]] = mapped_column(Integer, index=True)
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    room_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("rooms.id", ondelete="SET NULL")
    )
    current_location: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='available',
        nullable=False,
        index=True,
        comment="available, in_use, maintenance, repair, out_of_service, disposed"
    )
    is_operational: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    
    # Condition
    condition: Mapped[str] = mapped_column(
        String(20),
        default='good',
        nullable=False,
        comment="excellent, good, fair, poor, critical"
    )
    
    # Maintenance
    last_maintenance_date: Mapped[Optional[str]] = mapped_column(String(20))
    next_maintenance_date: Mapped[Optional[str]] = mapped_column(String(20), index=True)
    maintenance_frequency_days: Mapped[Optional[int]] = mapped_column(Integer)
    maintenance_cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Calibration (for precision equipment)
    requires_calibration: Mapped[bool] = mapped_column(Boolean, default=False)
    last_calibration_date: Mapped[Optional[str]] = mapped_column(String(20))
    next_calibration_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Safety & Compliance
    requires_certification: Mapped[bool] = mapped_column(Boolean, default=False)
    certification_number: Mapped[Optional[str]] = mapped_column(String(100))
    certification_expiry: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Assignment
    assigned_to: Mapped[Optional[str]] = mapped_column(String(200))
    assigned_to_staff_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="SET NULL")
    )
    
    # Usage
    is_portable: Mapped[bool] = mapped_column(Boolean, default=False)
    requires_training: Mapped[bool] = mapped_column(Boolean, default=False)
    usage_count: Mapped[int] = mapped_column(Integer, default=0)
    
    # Specifications
    specifications: Mapped[Optional[str]] = mapped_column(Text, comment="JSON format")
    operating_instructions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Documents
    manual_url: Mapped[Optional[str]] = mapped_column(String(500))
    certificate_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Asset Management
    asset_tag: Mapped[Optional[str]] = mapped_column(String(50), unique=True)
    barcode: Mapped[Optional[str]] = mapped_column(String(100), unique=True)
    qr_code: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Depreciation
    depreciation_rate: Mapped[Optional[Decimal]] = mapped_column(Numeric(5, 2))
    current_value: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    floor: Mapped[Optional["Floor"]] = relationship(
        "Floor",
        back_populates="equipment"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="equipment_list"
    )
    
    room: Mapped[Optional["Room"]] = relationship(
        "Room",
        backref="equipment_list"
    )
    
    assigned_staff: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        backref="assigned_equipment"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('purchase_price >= 0 OR purchase_price IS NULL', name='equipment_positive_purchase_price'),
        CheckConstraint('maintenance_cost >= 0 OR maintenance_cost IS NULL', name='equipment_positive_maintenance_cost'),
        CheckConstraint('usage_count >= 0', name='equipment_positive_usage_count'),
        CheckConstraint('depreciation_rate >= 0 AND depreciation_rate <= 100 OR depreciation_rate IS NULL', name='equipment_valid_depreciation_rate'),
        Index('idx_equipment_floor', 'floor_id', 'status'),
        Index('idx_equipment_department', 'department_id', 'status'),
        Index('idx_equipment_type', 'equipment_type', 'status'),
        Index('idx_equipment_maintenance', 'next_maintenance_date', 'status'),
        {'comment': 'Medical equipment and asset tracking with floor locations'}
    )
    
    # Validators
    @validates('equipment_type')
    def validate_equipment_type(self, key, value):
        valid_types = [
            'diagnostic', 'surgical', 'monitoring', 'life_support',
            'imaging', 'laboratory', 'therapeutic', 'sterilization'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Equipment type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['available', 'in_use', 'maintenance', 'repair', 'out_of_service', 'disposed', 'reserved']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('condition')
    def validate_condition(self, key, value):
        valid_conditions = ['excellent', 'good', 'fair', 'poor', 'critical']
        if value.lower() not in valid_conditions:
            raise ValueError(f"Condition must be one of: {', '.join(valid_conditions)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Equipment(id={self.id}, name='{self.name}', serial='{self.serial_number}', status='{self.status}')>"

==================================================

FILE: event.py
----------------------------------------
"""
Event Model
Hospital events, meetings, and activities
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Event(BaseModel):
    """
    Event and activity model
    """
    
    __tablename__ = "events"
    
    # Event Details
    event_code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    title: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    description: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Event Type
    event_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="meeting, training, seminar, conference, health_camp, awareness, celebration"
    )
    
    # Timing
    event_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    start_time: Mapped[str] = mapped_column(String(10), nullable=False)
    end_time: Mapped[str] = mapped_column(String(10), nullable=False)
    duration_hours: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Location
    location: Mapped[str] = mapped_column(String(200), nullable=False)
    venue: Mapped[Optional[str]] = mapped_column(String(200))
    floor_number: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Organizer
    organizer: Mapped[str] = mapped_column(String(200), nullable=False)
    contact_person: Mapped[Optional[str]] = mapped_column(String(200))
    contact_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL")
    )
    
    # Attendance
    max_participants: Mapped[Optional[int]] = mapped_column(Integer)
    registered_participants: Mapped[int] = mapped_column(Integer, default=0)
    
    # Registration
    requires_registration: Mapped[bool] = mapped_column(Boolean, default=False)
    registration_deadline: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='scheduled',
        nullable=False,
        index=True,
        comment="scheduled, ongoing, completed, cancelled, postponed"
    )
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='normal',
        nullable=False,
        comment="low, normal, high, urgent"
    )
    
    # Visibility
    is_public: Mapped[bool] = mapped_column(Boolean, default=False)
    target_audience: Mapped[Optional[str]] = mapped_column(String(200), comment="staff, doctors, patients, public")
    
    # Resources
    resources_required: Mapped[Optional[str]] = mapped_column(Text)
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    agenda: Mapped[Optional[str]] = mapped_column(Text)
    
    # Attachments
    attachment_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="events"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('max_participants >= 0 OR max_participants IS NULL', name='event_positive_max_participants'),
        CheckConstraint('registered_participants >= 0', name='event_positive_registered'),
        Index('idx_event_date', 'event_date', 'status'),
        Index('idx_event_type', 'event_type', 'status'),
        {'comment': 'Hospital events, meetings, and activities'}
    )
    
    # Validators
    @validates('event_type')
    def validate_event_type(self, key, value):
        valid_types = [
            'meeting', 'training', 'seminar', 'conference', 'health_camp',
            'awareness', 'celebration', 'workshop', 'webinar'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Event type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['scheduled', 'ongoing', 'completed', 'cancelled', 'postponed']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Event(id={self.id}, title='{self.title}', date='{self.event_date}')>"

==================================================

FILE: expense.py
----------------------------------------
"""
Expense Model
Hospital expenses and costs tracking
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Expense(BaseModel):
    """
    Expense tracking model
    """
    
    __tablename__ = "expenses"
    
    # Expense Details
    expense_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    expense_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Category
    category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="salaries, utilities, supplies, maintenance, equipment, rent, insurance, taxes"
    )
    subcategory: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Description
    description: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Amount
    amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    total_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Department (if applicable)
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    
    # Vendor/Supplier
    vendor_name: Mapped[Optional[str]] = mapped_column(String(200))
    vendor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("vendors.id", ondelete="SET NULL")
    )
    
    # Invoice
    invoice_number: Mapped[Optional[str]] = mapped_column(String(50))
    invoice_date: Mapped[Optional[str]] = mapped_column(String(20))
    invoice_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Payment
    payment_method: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="cash, cheque, bank_transfer, card, online"
    )
    payment_status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, paid, partially_paid, overdue"
    )
    payment_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Approval
    approved_by: Mapped[Optional[str]] = mapped_column(String(200))
    approval_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Recurring
    is_recurring: Mapped[bool] = mapped_column(Boolean, default=False)
    recurrence_frequency: Mapped[Optional[str]] = mapped_column(String(20), comment="monthly, quarterly, yearly")
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="expenses"
    )
    
    vendor: Mapped[Optional["Vendor"]] = relationship(
        "Vendor",
        backref="expenses"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('amount > 0', name='expense_positive_amount'),
        CheckConstraint('tax_amount >= 0', name='expense_positive_tax'),
        CheckConstraint('total_amount > 0', name='expense_positive_total'),
        Index('idx_expense_category', 'category', 'expense_date'),
        Index('idx_expense_department', 'department_id', 'expense_date'),
        Index('idx_expense_payment', 'payment_status', 'expense_date'),
        {'comment': 'Hospital expenses and costs tracking'}
    )
    
    # Validators
    @validates('category')
    def validate_category(self, key, value):
        valid_categories = [
            'salaries', 'utilities', 'supplies', 'maintenance',
            'equipment', 'rent', 'insurance', 'taxes', 'marketing',
            'administrative', 'medical_supplies', 'pharmaceuticals'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('payment_status')
    def validate_payment_status(self, key, value):
        valid_statuses = ['pending', 'paid', 'partially_paid', 'overdue']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Payment status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Expense(id={self.id}, number='{self.expense_number}', amount={self.total_amount})>"

==================================================

FILE: faq.py
----------------------------------------
"""
FAQ Model
Frequently Asked Questions
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class FAQ(BaseModel):
    """
    FAQ model
    """
    
    __tablename__ = "faqs"
    
    # Question
    question: Mapped[str] = mapped_column(String(500), nullable=False, index=True)
    
    # Answer
    answer: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Category
    category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="general, appointments, billing, services, emergency, insurance, pharmacy"
    )
    
    # Order/Priority
    display_order: Mapped[int] = mapped_column(Integer, default=0)
    
    # Tags
    tags: Mapped[Optional[str]] = mapped_column(String(500), comment="Comma-separated tags")
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='published',
        nullable=False,
        index=True,
        comment="draft, published, archived"
    )
    
    # Views
    view_count: Mapped[int] = mapped_column(Integer, default=0)
    
    # Helpful
    helpful_count: Mapped[int] = mapped_column(Integer, default=0)
    not_helpful_count: Mapped[int] = mapped_column(Integer, default=0)
    
    # Language
    language: Mapped[str] = mapped_column(String(10), default='en')
    
    # Related
    related_faqs: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of FAQ IDs")
    
    # Created By
    created_by: Mapped[Optional[str]] = mapped_column(String(200))
    last_updated_by: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('view_count >= 0', name='faq_positive_view_count'),
        CheckConstraint('helpful_count >= 0', name='faq_positive_helpful_count'),
        CheckConstraint('not_helpful_count >= 0', name='faq_positive_not_helpful_count'),
        Index('idx_faq_category', 'category', 'status'),
        Index('idx_faq_order', 'display_order', 'status'),
        {'comment': 'Frequently Asked Questions'}
    )
    
    # Validators
    @validates('category')
    def validate_category(self, key, value):
        valid_categories = [
            'general', 'appointments', 'billing', 'services',
            'emergency', 'insurance', 'pharmacy', 'lab', 'technical'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['draft', 'published', 'archived']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<FAQ(id={self.id}, question='{self.question[:50]}...')>"

==================================================

FILE: feedback.py
----------------------------------------
"""
Feedback Model
Patient and service feedback
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Feedback(BaseModel):
    """
    Feedback model
    """
    
    __tablename__ = "feedbacks"
    
    # Feedback Details
    feedback_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Patient
    patient_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="SET NULL"),
        index=True
    )
    patient_name: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Contact
    email: Mapped[Optional[str]] = mapped_column(String(100))
    phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Related Service
    service_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="consultation, admission, emergency, lab, pharmacy, overall"
    )
    
    # Doctor/Staff (if applicable)
    doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL")
    )
    
    # Ratings (1-5 scale)
    overall_rating: Mapped[int] = mapped_column(Integer, nullable=False)
    staff_behavior_rating: Mapped[Optional[int]] = mapped_column(Integer)
    cleanliness_rating: Mapped[Optional[int]] = mapped_column(Integer)
    facilities_rating: Mapped[Optional[int]] = mapped_column(Integer)
    waiting_time_rating: Mapped[Optional[int]] = mapped_column(Integer)
    treatment_quality_rating: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Comments
    positive_comments: Mapped[Optional[str]] = mapped_column(Text)
    negative_comments: Mapped[Optional[str]] = mapped_column(Text)
    suggestions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Experience
    would_recommend: Mapped[Optional[bool]] = mapped_column(Boolean)
    
    # Feedback Date
    feedback_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    visit_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='received',
        nullable=False,
        comment="received, reviewed, responded, archived"
    )
    
    # Response
    response: Mapped[Optional[str]] = mapped_column(Text)
    responded_by: Mapped[Optional[str]] = mapped_column(String(200))
    response_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Public Display
    is_public: Mapped[bool] = mapped_column(Boolean, default=False)
    is_approved: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Source
    source: Mapped[str] = mapped_column(
        String(50),
        default='website',
        nullable=False,
        comment="website, app, email, survey, phone, sms"
    )
    
    # Relationships
    patient: Mapped[Optional["Patient"]] = relationship(
        "Patient",
        backref="feedbacks"
    )
    
    doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="feedbacks"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="feedbacks"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('overall_rating >= 1 AND overall_rating <= 5', name='feedback_valid_overall_rating'),
        CheckConstraint('staff_behavior_rating >= 1 AND staff_behavior_rating <= 5 OR staff_behavior_rating IS NULL', name='feedback_valid_staff_rating'),
        CheckConstraint('cleanliness_rating >= 1 AND cleanliness_rating <= 5 OR cleanliness_rating IS NULL', name='feedback_valid_cleanliness_rating'),
        CheckConstraint('facilities_rating >= 1 AND facilities_rating <= 5 OR facilities_rating IS NULL', name='feedback_valid_facilities_rating'),
        Index('idx_feedback_patient', 'patient_id', 'feedback_date'),
        Index('idx_feedback_service', 'service_type', 'overall_rating'),
        Index('idx_feedback_doctor', 'doctor_id', 'overall_rating'),
        {'comment': 'Patient and service feedback'}
    )
    
    # Validators
    @validates('service_type')
    def validate_service_type(self, key, value):
        valid_types = [
            'consultation', 'admission', 'emergency', 'lab',
            'pharmacy', 'overall', 'surgery', 'nursing_care'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Service type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['received', 'reviewed', 'responded', 'archived']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Feedback(id={self.id}, rating={self.overall_rating}, service='{self.service_type}')>"

==================================================

FILE: floor.py
----------------------------------------
"""
Floor Model - NEW
Manages building floors for hospital infrastructure
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, CheckConstraint, Index
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Floor(BaseModel):
    """
    Floor model for managing building floors
    Supports multi-floor hospitals with basement levels
    """
    
    __tablename__ = "floors"
    
    # Basic Information
    floor_number: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    floor_name: Mapped[str] = mapped_column(String(100), nullable=False)
    floor_code: Mapped[Optional[str]] = mapped_column(String(20), unique=True, index=True)
    
    # Building Reference
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="CASCADE"),
        nullable=True,
        index=True
    )
    branch_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("branches.id", ondelete="CASCADE"),
        nullable=True,
        index=True
    )
    
    # Floor Details
    total_rooms: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_wards: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    occupied_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Floor Specifications
    square_footage: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    
    # Floor Type/Purpose
    floor_type: Mapped[Optional[str]] = mapped_column(
        String(50),
        nullable=True,
        index=True,
        comment="general, icu, operation, emergency, administrative, diagnostic"
    )
    
    # Accessibility Features
    has_elevator: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_stairs: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    is_accessible: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_ramp: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Emergency & Safety
    has_emergency_exit: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    fire_extinguishers_count: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    emergency_assembly_point: Mapped[Optional[str]] = mapped_column(String(200), nullable=True)
    
    # Additional Features
    has_waiting_area: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_restroom: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_pantry: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        back_populates="floors",
        foreign_keys=[hospital_id]
    )
    
    branch: Mapped[Optional["Branch"]] = relationship(
        "Branch",
        back_populates="floors",
        foreign_keys=[branch_id]
    )
    
    rooms: Mapped[List["Room"]] = relationship(
        "Room",
        back_populates="floor",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    wards: Mapped[List["Ward"]] = relationship(
        "Ward",
        back_populates="floor",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    departments: Mapped[List["Department"]] = relationship(
        "Department",
        back_populates="main_floor",
        foreign_keys="Department.main_floor_id",
        lazy="dynamic"
    )
    
    equipment: Mapped[List["Equipment"]] = relationship(
        "Equipment",
        back_populates="floor",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('floor_number >= -10 AND floor_number <= 100', name='valid_floor_number'),
        CheckConstraint('total_rooms >= 0', name='positive_total_rooms'),
        CheckConstraint('total_wards >= 0', name='positive_total_wards'),
        CheckConstraint('total_beds >= 0', name='positive_total_beds'),
        CheckConstraint('occupied_beds >= 0', name='positive_occupied_beds'),
        CheckConstraint('occupied_beds <= total_beds', name='occupied_not_exceed_total'),
        CheckConstraint('fire_extinguishers_count >= 0', name='positive_fire_extinguishers'),
        Index('idx_floor_hospital', 'hospital_id', 'floor_number'),
        Index('idx_floor_branch', 'branch_id', 'floor_number'),
        Index('idx_floor_type', 'floor_type'),
        Index('idx_floor_active', 'is_active', 'is_deleted'),
        {'comment': 'Building floors for hospital infrastructure management'}
    )
    
    # Validators
    @validates('floor_number')
    def validate_floor_number(self, key, value):
        """Validate floor number is within acceptable range"""
        if value < -10 or value > 100:
            raise ValueError("Floor number must be between -10 (basement) and 100")
        return value
    
    @validates('floor_type')
    def validate_floor_type(self, key, value):
        """Validate floor type"""
        valid_types = [
            'general', 'icu', 'operation', 'emergency', 
            'administrative', 'diagnostic', 'pharmacy', 
            'laboratory', 'radiology', 'maternity'
        ]
        if value and value.lower() not in valid_types:
            raise ValueError(f"Floor type must be one of: {', '.join(valid_types)}")
        return value.lower() if value else None
    
    @validates('occupied_beds')
    def validate_occupied_beds(self, key, value):
        """Ensure occupied beds don't exceed total beds"""
        if value > self.total_beds:
            raise ValueError("Occupied beds cannot exceed total beds")
        return value
    
    # Properties
    @property
    def display_name(self) -> str:
        """Return formatted floor display name"""
        if self.floor_number == 0:
            return "Ground Floor"
        elif self.floor_number < 0:
            return f"Basement {abs(self.floor_number)}"
        elif self.floor_number == 1:
            return "1st Floor"
        elif self.floor_number == 2:
            return "2nd Floor"
        elif self.floor_number == 3:
            return "3rd Floor"
        else:
            return f"{self.floor_number}th Floor"
    
    @property
    def available_beds(self) -> int:
        """Calculate available beds"""
        return max(0, self.total_beds - self.occupied_beds)
    
    @property
    def occupancy_rate(self) -> float:
        """Calculate bed occupancy rate percentage"""
        if self.total_beds == 0:
            return 0.0
        return round((self.occupied_beds / self.total_beds) * 100, 2)
    
    @property
    def is_basement(self) -> bool:
        """Check if floor is basement"""
        return self.floor_number < 0
    
    @property
    def is_ground_floor(self) -> bool:
        """Check if floor is ground floor"""
        return self.floor_number == 0
    
    @property
    def is_fully_occupied(self) -> bool:
        """Check if all beds are occupied"""
        return self.occupied_beds >= self.total_beds and self.total_beds > 0
    
    # Methods
    def increment_beds(self, count: int = 1) -> None:
        """Increment occupied beds count"""
        new_count = self.occupied_beds + count
        if new_count > self.total_beds:
            raise ValueError("Cannot exceed total bed capacity")
        self.occupied_beds = new_count
    
    def decrement_beds(self, count: int = 1) -> None:
        """Decrement occupied beds count"""
        new_count = self.occupied_beds - count
        if new_count < 0:
            raise ValueError("Occupied beds cannot be negative")
        self.occupied_beds = new_count
    
    def __repr__(self) -> str:
        """String representation"""
        return f"<Floor(id={self.id}, name='{self.floor_name}', number={self.floor_number}, type='{self.floor_type}')>"
    


==================================================

FILE: hospital.py
----------------------------------------
"""
Hospital Model - Updated with Floor Support
Main hospital entity with multi-floor building support
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Numeric, CheckConstraint, Index
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
import re

from .base import BaseModel


class Hospital(BaseModel):
    """
    Hospital model - main entity
    Manages hospital information with floor infrastructure
    """
    
    __tablename__ = "hospitals"
    
    # Basic Information
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    registration_number: Mapped[Optional[str]] = mapped_column(String(100), unique=True)
    
    # Hospital Type
    hospital_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="general, specialized, clinic, multi_specialty, teaching, trauma_center"
    )
    
    # Location
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    state: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    country: Mapped[str] = mapped_column(String(100), nullable=False, default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    latitude: Mapped[Optional[Numeric]] = mapped_column(Numeric(10, 8), nullable=True)
    longitude: Mapped[Optional[Numeric]] = mapped_column(Numeric(11, 8), nullable=True)
    
    # Contact Information
    phone: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)
    email: Mapped[Optional[str]] = mapped_column(String(100), nullable=True, index=True)
    website: Mapped[Optional[str]] = mapped_column(String(200), nullable=True)
    emergency_phone: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)
    
    #  Building Details - UPDATED
    total_floors: Mapped[int] = mapped_column(Integer, default=1, nullable=False)
    basement_floors: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_buildings: Mapped[int] = mapped_column(Integer, default=1, nullable=False)
    total_area_sqft: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)
    
    # Capacity
    total_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_rooms: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_wards: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    icu_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    emergency_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    operation_theaters: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Staff Count
    total_doctors: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_nurses: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_staff: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Facilities
    has_emergency: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_ambulance: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_blood_bank: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_pharmacy: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_laboratory: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_radiology: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_icu: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_nicu: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_dialysis: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_mortuary: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_cafeteria: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_parking: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    
    # Accreditation & Licensing
    accreditation: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    accreditation_body: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    license_number: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    license_expiry_date: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)
    
    # Status
    status: Mapped[str] = mapped_column(String(20), default='active', nullable=False, index=True)
    is_24x7: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    is_government: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Additional Information
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    established_year: Mapped[Optional[int]] = mapped_column(Integer, nullable=True)
    specializations: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    
    # Relationships
    floors: Mapped[List["Floor"]] = relationship(
        "Floor",
        back_populates="hospital",
        cascade="all, delete-orphan",
        lazy="dynamic",
        foreign_keys="Floor.hospital_id"
    )
    
    branches: Mapped[List["Branch"]] = relationship(
        "Branch",
        back_populates="hospital",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    departments: Mapped[List["Department"]] = relationship(
        "Department",
        back_populates="hospital",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    doctors: Mapped[List["Doctor"]] = relationship(
        "Doctor",
        back_populates="hospital",
        lazy="dynamic"
    )
    
    nurses: Mapped[List["Nurse"]] = relationship(
        "Nurse",
        back_populates="hospital",
        lazy="dynamic"
    )
    
    patients: Mapped[List["Patient"]] = relationship(
        "Patient",
        back_populates="hospital",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_floors >= 1', name='min_one_floor'),
        CheckConstraint('basement_floors >= 0', name='positive_basement_floors'),
        CheckConstraint('total_beds >= 0', name='positive_total_beds'),
        CheckConstraint('total_rooms >= 0', name='positive_total_rooms'),
        CheckConstraint('established_year >= 1800 AND established_year <= 2100', name='valid_established_year'),
        Index('idx_hospital_location', 'city', 'state', 'country'),
        Index('idx_hospital_type_status', 'hospital_type', 'status'),
        {'comment': 'Main hospital entity with infrastructure details'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        """Validate email format"""
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('hospital_type')
    def validate_hospital_type(self, key, value):
        """Validate hospital type"""
        valid_types = [
            'general', 'specialized', 'clinic', 'multi_specialty',
            'teaching', 'trauma_center', 'maternity', 'pediatric'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Hospital type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['active', 'inactive', 'under_construction', 'temporary_closed']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    # Properties
    @property
    def total_floor_count(self) -> int:
        """Total floors including basement"""
        return self.total_floors + self.basement_floors
    
    @property
    def floor_range(self) -> tuple:
        """Return floor range (min, max)"""
        return (-self.basement_floors, self.total_floors)
    
    @property
    def full_address(self) -> str:
        """Return complete address"""
        return f"{self.address}, {self.city}, {self.state} {self.pincode}, {self.country}"
    
    def __repr__(self) -> str:
        """String representation"""
        return f"<Hospital(id={self.id}, name='{self.name}', code='{self.code}', floors={self.total_floors})>"
    


==================================================

FILE: imaging.py
----------------------------------------
"""
Imaging Model
Radiology and imaging services (X-Ray, CT, MRI, Ultrasound)
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Imaging(BaseModel):
    """
    Medical imaging and radiology model
    """
    
    __tablename__ = "imagings"
    
    # Imaging Details
    imaging_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Ordering Doctor
    ordered_by_doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Imaging Type
    imaging_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="xray, ct_scan, mri, ultrasound, mammography, pet_scan, fluoroscopy"
    )
    
    # Body Part/Region
    body_part: Mapped[str] = mapped_column(String(100), nullable=False)
    study_description: Mapped[str] = mapped_column(String(200), nullable=False)
    
    # Modality
    modality: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Scheduling
    order_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    order_time: Mapped[str] = mapped_column(String(10), nullable=False)
    scheduled_date: Mapped[Optional[str]] = mapped_column(String(20), index=True)
    scheduled_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Actual Timing
    actual_date: Mapped[Optional[str]] = mapped_column(String(20))
    actual_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='routine',
        nullable=False,
        comment="stat, urgent, routine"
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, scheduled, in_progress, completed, cancelled, reported"
    )
    
    # Clinical Information
    clinical_indication: Mapped[str] = mapped_column(Text, nullable=False)
    relevant_history: Mapped[Optional[str]] = mapped_column(Text)
    
    # Technician
    performed_by: Mapped[Optional[str]] = mapped_column(String(200))
    technician_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="SET NULL")
    )
    
    # Radiologist
    radiologist_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    reported_by: Mapped[Optional[str]] = mapped_column(String(200))
    report_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Findings
    findings: Mapped[Optional[str]] = mapped_column(Text)
    impression: Mapped[Optional[str]] = mapped_column(Text)
    recommendations: Mapped[Optional[str]] = mapped_column(Text)
    
    # Contrast
    contrast_used: Mapped[bool] = mapped_column(Boolean, default=False)
    contrast_type: Mapped[Optional[str]] = mapped_column(String(100))
    contrast_amount: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Radiation (for X-Ray, CT)
    radiation_dose: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Images
    image_count: Mapped[Optional[int]] = mapped_column(Integer)
    images_urls: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of image URLs")
    dicom_study_id: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Report
    report_url: Mapped[Optional[str]] = mapped_column(String(500))
    is_abnormal: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Cost
    cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Location
    imaging_center: Mapped[Optional[str]] = mapped_column(String(200))
    imaging_floor: Mapped[Optional[int]] = mapped_column(Integer)  #  Floor reference
    
    # Patient Preparation
    preparation_instructions: Mapped[Optional[str]] = mapped_column(Text)
    fasting_required: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Quality
    image_quality: Mapped[Optional[str]] = mapped_column(String(20), comment="excellent, good, adequate, poor")
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    technician_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="imaging_studies"
    )
    
    ordered_by: Mapped["Doctor"] = relationship(
        "Doctor",
        foreign_keys=[ordered_by_doctor_id],
        backref="ordered_imaging_studies"
    )
    
    radiologist: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        foreign_keys=[radiologist_id],
        backref="reported_imaging_studies"
    )
    
    technician: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        backref="performed_imaging_studies"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('cost >= 0 OR cost IS NULL', name='imaging_positive_cost'),
        CheckConstraint('image_count >= 0 OR image_count IS NULL', name='imaging_positive_image_count'),
        Index('idx_imaging_patient', 'patient_id', 'order_date'),
        Index('idx_imaging_type', 'imaging_type', 'status'),
        Index('idx_imaging_priority', 'priority', 'status'),
        Index('idx_imaging_scheduled', 'scheduled_date', 'status'),
        {'comment': 'Medical imaging and radiology services'}
    )
    
    # Validators
    @validates('imaging_type')
    def validate_imaging_type(self, key, value):
        valid_types = [
            'xray', 'ct_scan', 'mri', 'ultrasound', 'mammography',
            'pet_scan', 'fluoroscopy', 'dexa_scan', 'echocardiogram'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Imaging type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('priority')
    def validate_priority(self, key, value):
        valid_priorities = ['stat', 'urgent', 'routine']
        if value.lower() not in valid_priorities:
            raise ValueError(f"Priority must be one of: {', '.join(valid_priorities)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['pending', 'scheduled', 'in_progress', 'completed', 'cancelled', 'reported']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Imaging(id={self.id}, number='{self.imaging_number}', type='{self.imaging_type}', status='{self.status}')>"

==================================================

FILE: insurance.py
----------------------------------------
"""
Insurance Model
Patient insurance information and claims
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Insurance(BaseModel):
    """
    Patient insurance and claims model
    """
    
    __tablename__ = "insurances"
    
    # Insurance Details
    insurance_number: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    policy_number: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Insurance Provider
    provider_name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    provider_code: Mapped[Optional[str]] = mapped_column(String(50))
    provider_phone: Mapped[Optional[str]] = mapped_column(String(20))
    provider_email: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Policy Details
    policy_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="individual, family, group, corporate, government"
    )
    plan_name: Mapped[str] = mapped_column(String(200), nullable=False)
    
    # Coverage
    coverage_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    used_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    remaining_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Validity
    start_date: Mapped[str] = mapped_column(String(20), nullable=False)
    end_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    
    # Policy Holder (if different from patient)
    policy_holder_name: Mapped[str] = mapped_column(String(200), nullable=False)
    policy_holder_relation: Mapped[Optional[str]] = mapped_column(String(50))
    policy_holder_dob: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Co-payment
    copay_percentage: Mapped[Optional[Decimal]] = mapped_column(Numeric(5, 2))
    copay_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Deductible
    annual_deductible: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    deductible_met: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    
    # Coverage Details
    inpatient_coverage: Mapped[bool] = mapped_column(Boolean, default=True)
    outpatient_coverage: Mapped[bool] = mapped_column(Boolean, default=True)
    emergency_coverage: Mapped[bool] = mapped_column(Boolean, default=True)
    maternity_coverage: Mapped[bool] = mapped_column(Boolean, default=False)
    dental_coverage: Mapped[bool] = mapped_column(Boolean, default=False)
    vision_coverage: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Pre-existing Conditions
    pre_existing_covered: Mapped[bool] = mapped_column(Boolean, default=False)
    waiting_period_months: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Network
    network_type: Mapped[Optional[str]] = mapped_column(String(50), comment="PPO, HMO, EPO, POS")
    is_network_hospital: Mapped[bool] = mapped_column(Boolean, default=True)
    
    # Claims
    total_claims: Mapped[int] = mapped_column(Integer, default=0)
    approved_claims: Mapped[int] = mapped_column(Integer, default=0)
    rejected_claims: Mapped[int] = mapped_column(Integer, default=0)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, expired, cancelled, suspended"
    )
    
    # Documents
    policy_document_url: Mapped[Optional[str]] = mapped_column(String(500))
    id_card_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    exclusions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="insurances"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('coverage_amount > 0', name='insurance_positive_coverage'),
        CheckConstraint('used_amount >= 0', name='insurance_positive_used'),
        CheckConstraint('remaining_amount >= 0', name='insurance_positive_remaining'),
        CheckConstraint('copay_percentage >= 0 AND copay_percentage <= 100 OR copay_percentage IS NULL', name='insurance_valid_copay_percentage'),
        Index('idx_insurance_patient', 'patient_id', 'status'),
        Index('idx_insurance_provider', 'provider_name', 'status'),
        Index('idx_insurance_expiry', 'end_date', 'status'),
        {'comment': 'Patient insurance policies and coverage'}
    )
    
    # Validators
    @validates('policy_type')
    def validate_policy_type(self, key, value):
        valid_types = ['individual', 'family', 'group', 'corporate', 'government', 'senior_citizen']
        if value.lower() not in valid_types:
            raise ValueError(f"Policy type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'expired', 'cancelled', 'suspended', 'pending_renewal']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @property
    def utilization_percentage(self) -> Decimal:
        """Calculate coverage utilization percentage"""
        if self.coverage_amount > 0:
            return (self.used_amount / self.coverage_amount) * 100
        return Decimal(0)
    
    def __repr__(self) -> str:
        return f"<Insurance(id={self.id}, policy='{self.policy_number}', provider='{self.provider_name}')>"

==================================================

FILE: inventory.py
----------------------------------------
"""
Inventory Model
General inventory and supplies management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Inventory(BaseModel):
    """
    General inventory and supplies model
    """
    
    __tablename__ = "inventories"
    
    # Item Details
    item_code: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    item_name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    
    # Category
    category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="medical_supplies, surgical_supplies, consumables, stationery, cleaning, food"
    )
    subcategory: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Description
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Unit
    unit_of_measurement: Mapped[str] = mapped_column(String(20), nullable=False, comment="pieces, boxes, kg, liters")
    
    # Stock Information
    current_stock: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    minimum_stock: Mapped[int] = mapped_column(Integer, default=10, nullable=False)
    maximum_stock: Mapped[int] = mapped_column(Integer, default=1000, nullable=False)
    reorder_level: Mapped[int] = mapped_column(Integer, default=20, nullable=False)
    
    # Pricing
    unit_price: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    total_value: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    
    # Supplier
    supplier_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("suppliers.id", ondelete="SET NULL"),
        index=True
    )
    supplier_name: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Location
    storage_location: Mapped[Optional[str]] = mapped_column(String(200))
    shelf_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Batch/Lot
    batch_number: Mapped[Optional[str]] = mapped_column(String(50))
    manufacturing_date: Mapped[Optional[str]] = mapped_column(String(20))
    expiry_date: Mapped[Optional[str]] = mapped_column(String(20), index=True)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, discontinued, expired, out_of_stock"
    )
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    
    # Tracking
    barcode: Mapped[Optional[str]] = mapped_column(String(100), unique=True)
    sku: Mapped[Optional[str]] = mapped_column(String(50), unique=True)
    
    # Last Restock
    last_restocked_date: Mapped[Optional[str]] = mapped_column(String(20))
    last_restocked_quantity: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Usage
    total_consumed: Mapped[int] = mapped_column(Integer, default=0)
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    supplier: Mapped[Optional["Supplier"]] = relationship(
        "Supplier",
        backref="inventory_items"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('current_stock >= 0', name='inventory_positive_current_stock'),
        CheckConstraint('minimum_stock >= 0', name='inventory_positive_minimum_stock'),
        CheckConstraint('maximum_stock >= minimum_stock', name='inventory_max_greater_than_min'),
        CheckConstraint('reorder_level >= 0', name='inventory_positive_reorder_level'),
        CheckConstraint('unit_price >= 0', name='inventory_positive_unit_price'),
        CheckConstraint('total_value >= 0', name='inventory_positive_total_value'),
        Index('idx_inventory_category', 'category', 'status'),
        Index('idx_inventory_stock', 'current_stock', 'reorder_level'),
        Index('idx_inventory_expiry', 'expiry_date', 'status'),
        {'comment': 'General inventory and supplies management'}
    )
    
    # Validators
    @validates('category')
    def validate_category(self, key, value):
        valid_categories = [
            'medical_supplies', 'surgical_supplies', 'consumables',
            'stationery', 'cleaning', 'food', 'linen', 'ppe'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'discontinued', 'expired', 'out_of_stock', 'recalled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @property
    def is_low_stock(self) -> bool:
        """Check if stock is below reorder level"""
        return self.current_stock <= self.reorder_level
    
    @property
    def stock_percentage(self) -> float:
        """Calculate stock percentage"""
        if self.maximum_stock > 0:
            return (self.current_stock / self.maximum_stock) * 100
        return 0.0
    
    def __repr__(self) -> str:
        return f"<Inventory(id={self.id}, name='{self.item_name}', stock={self.current_stock})>"

==================================================

FILE: lab_report.py
----------------------------------------
"""
Lab Report Model
Laboratory test results and reports
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class LabReport(BaseModel):
    """
    Laboratory test report model
    """
    
    __tablename__ = "lab_reports"
    
    # Report Details
    report_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Test Reference
    lab_test_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("lab_tests.id", ondelete="CASCADE"),
        unique=True,
        nullable=False,
        index=True
    )
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Report Details
    report_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    report_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Results
    test_results: Mapped[str] = mapped_column(Text, nullable=False, comment="JSON format with test parameters")
    interpretation: Mapped[Optional[str]] = mapped_column(Text)
    findings: Mapped[Optional[str]] = mapped_column(Text)
    
    # Status
    result_status: Mapped[str] = mapped_column(
        String(20),
        default='normal',
        nullable=False,
        index=True,
        comment="normal, abnormal, critical, inconclusive"
    )
    
    # Staff
    tested_by: Mapped[Optional[str]] = mapped_column(String(200))
    verified_by: Mapped[Optional[str]] = mapped_column(String(200))
    approved_by_doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    
    # Reference Values
    reference_ranges: Mapped[Optional[str]] = mapped_column(Text, comment="JSON format")
    
    # Notes
    technician_notes: Mapped[Optional[str]] = mapped_column(Text)
    doctor_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Attachments
    report_file_url: Mapped[Optional[str]] = mapped_column(String(500))
    images_urls: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of image URLs")
    
    # Critical Value Alert
    is_critical: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, index=True)
    critical_value_notified: Mapped[bool] = mapped_column(Boolean, default=False)
    notified_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Quality Control
    quality_check_passed: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    quality_check_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    lab_test: Mapped["LabTest"] = relationship(
        "LabTest",
        back_populates="lab_report"
    )
    
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="lab_reports"
    )
    
    approved_by: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="approved_lab_reports"
    )
    
    # Table Arguments
    __table_args__ = (
        Index('idx_labreport_patient', 'patient_id', 'report_date'),
        Index('idx_labreport_status', 'result_status', 'is_critical'),
        {'comment': 'Laboratory test results and reports'}
    )
    
    # Validators
    @validates('result_status')
    def validate_result_status(self, key, value):
        valid_statuses = ['normal', 'abnormal', 'critical', 'inconclusive', 'pending_review']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Result status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<LabReport(id={self.id}, number='{self.report_number}', status='{self.result_status}')>"

==================================================

FILE: lab_test.py
----------------------------------------
"""
Lab Test Model
Laboratory test orders and tracking
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal

from .base import BaseModel


class LabTest(BaseModel):
    """
    Laboratory test order model
    """
    
    __tablename__ = "lab_tests"
    
    # Test Details
    test_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    test_name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    test_code: Mapped[Optional[str]] = mapped_column(String(50), index=True)
    
    # Patient and Doctor
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    ordered_by_doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Test Category
    test_category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="blood, urine, stool, imaging, pathology, microbiology, biochemistry"
    )
    
    # Test Type
    test_type: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        comment="routine, urgent, stat, fasting, culture, biopsy"
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, sample_collected, in_progress, completed, cancelled, rejected"
    )
    
    # Dates and Times
    order_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    order_time: Mapped[str] = mapped_column(String(10), nullable=False)
    sample_collection_date: Mapped[Optional[str]] = mapped_column(String(20))
    sample_collection_time: Mapped[Optional[str]] = mapped_column(String(10))
    report_date: Mapped[Optional[str]] = mapped_column(String(20))
    report_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Sample Details
    sample_type: Mapped[Optional[str]] = mapped_column(String(50), comment="blood, serum, plasma, urine, etc.")
    sample_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True, index=True)
    sample_collected_by: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='routine',
        nullable=False,
        index=True,
        comment="routine, urgent, stat"
    )
    
    # Instructions
    special_instructions: Mapped[Optional[str]] = mapped_column(Text)
    fasting_required: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Cost
    test_cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Notes
    clinical_notes: Mapped[Optional[str]] = mapped_column(Text)
    rejection_reason: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        back_populates="lab_tests"
    )
    
    ordered_by: Mapped["Doctor"] = relationship(
        "Doctor",
        backref="ordered_lab_tests"
    )
    
    lab_report: Mapped[Optional["LabReport"]] = relationship(
        "LabReport",
        back_populates="lab_test",
        uselist=False
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('test_cost >= 0 OR test_cost IS NULL', name='labtest_positive_cost'),
        Index('idx_labtest_patient', 'patient_id', 'status'),
        Index('idx_labtest_doctor', 'ordered_by_doctor_id'),
        Index('idx_labtest_order_date', 'order_date', 'priority'),
        Index('idx_labtest_category', 'test_category', 'status'),
        {'comment': 'Laboratory test orders and tracking'}
    )
    
    # Validators
    @validates('test_category')
    def validate_test_category(self, key, value):
        valid_categories = [
            'blood', 'urine', 'stool', 'imaging', 'pathology',
            'microbiology', 'biochemistry', 'hematology', 'serology'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Test category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = [
            'pending', 'sample_collected', 'in_progress',
            'completed', 'cancelled', 'rejected'
        ]
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('priority')
    def validate_priority(self, key, value):
        valid_priorities = ['routine', 'urgent', 'stat']
        if value.lower() not in valid_priorities:
            raise ValueError(f"Priority must be one of: {', '.join(valid_priorities)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<LabTest(id={self.id}, number='{self.test_number}', name='{self.test_name}', status='{self.status}')>"

==================================================

FILE: leave.py
----------------------------------------
"""
Leave Model
Staff leave request and management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Leave(BaseModel):
    """
    Leave request model
    """
    
    __tablename__ = "leaves"
    
    # Leave Details
    leave_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Staff Reference
    staff_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="CASCADE"),
        index=True
    )
    doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        index=True
    )
    nurse_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("nurses.id", ondelete="CASCADE"),
        index=True
    )
    
    # Employee Info
    employee_name: Mapped[str] = mapped_column(String(200), nullable=False)
    employee_id: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    
    # Leave Type
    leave_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="sick, casual, earned, maternity, paternity, unpaid, compensatory, bereavement"
    )
    
    # Duration
    start_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    end_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    total_days: Mapped[int] = mapped_column(Integer, nullable=False)
    
    # Half Day
    is_half_day: Mapped[bool] = mapped_column(Boolean, default=False)
    half_day_session: Mapped[Optional[str]] = mapped_column(String(20), comment="first_half, second_half")
    
    # Reason
    reason: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Application Date
    application_date: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, approved, rejected, cancelled"
    )
    
    # Approval
    approved_by: Mapped[Optional[str]] = mapped_column(String(200))
    approval_date: Mapped[Optional[str]] = mapped_column(String(20))
    approval_remarks: Mapped[Optional[str]] = mapped_column(Text)
    
    # Rejection
    rejected_by: Mapped[Optional[str]] = mapped_column(String(200))
    rejection_date: Mapped[Optional[str]] = mapped_column(String(20))
    rejection_reason: Mapped[Optional[str]] = mapped_column(Text)
    
    # Supporting Documents
    attachment_url: Mapped[Optional[str]] = mapped_column(String(500))
    medical_certificate_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Contact During Leave
    contact_number: Mapped[Optional[str]] = mapped_column(String(20))
    emergency_contact: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Handover
    handover_to: Mapped[Optional[str]] = mapped_column(String(200))
    handover_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    staff: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        back_populates="leaves"
    )
    
    doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="leaves"
    )
    
    nurse: Mapped[Optional["Nurse"]] = relationship(
        "Nurse",
        backref="leaves"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_days > 0', name='leave_positive_days'),
        Index('idx_leave_employee', 'employee_id', 'start_date'),
        Index('idx_leave_dates', 'start_date', 'end_date'),
        Index('idx_leave_type_status', 'leave_type', 'status'),
        {'comment': 'Staff leave requests and management'}
    )
    
    # Validators
    @validates('leave_type')
    def validate_leave_type(self, key, value):
        valid_types = [
            'sick', 'casual', 'earned', 'maternity', 'paternity',
            'unpaid', 'compensatory', 'bereavement', 'study', 'sabbatical'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Leave type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['pending', 'approved', 'rejected', 'cancelled', 'withdrawn']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Leave(id={self.id}, number='{self.leave_number}', employee='{self.employee_name}', type='{self.leave_type}')>"

==================================================

FILE: maintenance.py
----------------------------------------
"""
 Maintenance model - Equipment maintenance logs
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime, Float, Text
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Maintenance(Base):
    __tablename__ = "maintenance_logs"

    id = Column(Integer, primary_key=True, index=True)
    equipment_id = Column(Integer, ForeignKey("equipment.id", ondelete="CASCADE"), nullable=False)
    
    maintenance_type = Column(String, nullable=False)  # Preventive, Corrective, Emergency
    maintenance_date = Column(DateTime, nullable=False)
    
    # Details
    problem_reported = Column(Text, nullable=True)
    action_taken = Column(Text, nullable=True)
    
    # Technician
    technician_name = Column(String, nullable=True)
    vendor_name = Column(String, nullable=True)
    
    # Cost
    cost = Column(Float, nullable=True)
    
    # Status
    status = Column(String, default="Pending")  # Pending, In-Progress, Completed
    
    # Next maintenance
    next_maintenance_date = Column(DateTime, nullable=True)
    
    notes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships
    equipment = relationship("Equipment", back_populates="maintenance_records")

==================================================

FILE: medical_record.py
----------------------------------------
"""
 MedicalRecord model
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class MedicalRecord(Base):
    __tablename__ = "medical_records"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    diagnosis_id = Column(Integer, ForeignKey("diagnoses.id", ondelete="SET NULL"), nullable=True)
    notes = Column(String, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    #  Relationships
    patient = relationship("Patient", back_populates="medical_records")
    diagnosis = relationship("Diagnosis")

==================================================

FILE: medicine.py
----------------------------------------
"""
Medicine Model
Medicine inventory and catalog
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal

from .base import BaseModel


class Medicine(BaseModel):
    """
    Medicine catalog and inventory model
    """
    
    __tablename__ = "medicines"
    
    # Medicine Details
    medicine_code: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    generic_name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    brand_name: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Classification
    category: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="antibiotic, analgesic, antipyretic, antiviral, etc."
    )
    drug_class: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Form and Strength
    dosage_form: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="tablet, capsule, syrup, injection, ointment, drops"
    )
    strength: Mapped[str] = mapped_column(String(50), nullable=False)
    unit: Mapped[str] = mapped_column(String(20), nullable=False, comment="mg, ml, g, IU")
    
    # Manufacturer
    manufacturer: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    supplier: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Stock Information
    stock_quantity: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    reorder_level: Mapped[int] = mapped_column(Integer, default=10, nullable=False)
    unit_of_measurement: Mapped[str] = mapped_column(String(20), default='units', nullable=False)
    
    # Pricing
    purchase_price: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    selling_price: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    mrp: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2), comment="Maximum Retail Price")
    
    # Batch Information
    batch_number: Mapped[Optional[str]] = mapped_column(String(50))
    manufacturing_date: Mapped[Optional[str]] = mapped_column(String(20))
    expiry_date: Mapped[Optional[str]] = mapped_column(String(20), index=True)
    
    # Prescription
    requires_prescription: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    is_controlled_substance: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    schedule_category: Mapped[Optional[str]] = mapped_column(String(20), comment="Schedule H, X, etc.")
    
    # Usage Instructions
    usage_instructions: Mapped[Optional[str]] = mapped_column(Text)
    dosage_instructions: Mapped[Optional[str]] = mapped_column(Text)
    side_effects: Mapped[Optional[str]] = mapped_column(Text)
    contraindications: Mapped[Optional[str]] = mapped_column(Text)
    warnings: Mapped[Optional[str]] = mapped_column(Text)
    
    # Storage
    storage_conditions: Mapped[Optional[str]] = mapped_column(String(200))
    storage_location: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, discontinued, out_of_stock, expired"
    )
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    
    # Additional Info
    description: Mapped[Optional[str]] = mapped_column(Text)
    barcode: Mapped[Optional[str]] = mapped_column(String(100), unique=True)
    
    # Relationships
    prescriptions: Mapped[List["Prescription"]] = relationship(
        "Prescription",
        back_populates="medicine",
        secondary="prescription_medicines",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('stock_quantity >= 0', name='medicine_positive_stock'),
        CheckConstraint('reorder_level >= 0', name='medicine_positive_reorder'),
        CheckConstraint('purchase_price > 0', name='medicine_positive_purchase_price'),
        CheckConstraint('selling_price > 0', name='medicine_positive_selling_price'),
        Index('idx_medicine_stock', 'stock_quantity', 'reorder_level'),
        Index('idx_medicine_category', 'category', 'status'),
        Index('idx_medicine_expiry', 'expiry_date', 'status'),
        {'comment': 'Medicine catalog and inventory management'}
    )
    
    # Validators
    @validates('dosage_form')
    def validate_dosage_form(self, key, value):
        valid_forms = [
            'tablet', 'capsule', 'syrup', 'injection', 'ointment',
            'cream', 'drops', 'inhaler', 'patch', 'powder', 'solution'
        ]
        if value.lower() not in valid_forms:
            raise ValueError(f"Dosage form must be one of: {', '.join(valid_forms)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'discontinued', 'out_of_stock', 'expired', 'recalled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @property
    def is_low_stock(self) -> bool:
        """Check if stock is below reorder level"""
        return self.stock_quantity <= self.reorder_level
    
    @property
    def profit_margin(self) -> Decimal:
        """Calculate profit margin percentage"""
        if self.purchase_price > 0:
            return ((self.selling_price - self.purchase_price) / self.purchase_price) * 100
        return Decimal(0)
    
    def __repr__(self) -> str:
        return f"<Medicine(id={self.id}, name='{self.name}', code='{self.medicine_code}', stock={self.stock_quantity})>"

==================================================

FILE: message.py
----------------------------------------
"""
Message Model
Internal messaging system
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Message(BaseModel):
    """
    Internal message model
    """
    
    __tablename__ = "messages"
    
    # Message Details
    subject: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    body: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Sender
    sender_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    sender_name: Mapped[str] = mapped_column(String(200), nullable=False)
    sender_type: Mapped[str] = mapped_column(String(20), comment="patient, doctor, nurse, staff, admin")
    
    # Recipient
    recipient_id: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    recipient_name: Mapped[str] = mapped_column(String(200), nullable=False)
    recipient_type: Mapped[str] = mapped_column(String(20))
    
    # Message Type
    message_type: Mapped[str] = mapped_column(
        String(50),
        default='direct',
        nullable=False,
        comment="direct, broadcast, announcement, reply"
    )
    
    # Thread (for replies)
    parent_message_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("messages.id", ondelete="CASCADE"),
        index=True
    )
    thread_id: Mapped[Optional[str]] = mapped_column(String(50), index=True)
    
    # Status
    is_read: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, index=True)
    read_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Flags
    is_starred: Mapped[bool] = mapped_column(Boolean, default=False)
    is_archived: Mapped[bool] = mapped_column(Boolean, default=False)
    is_draft: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='normal',
        nullable=False,
        comment="low, normal, high, urgent"
    )
    
    # Attachments
    attachments: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of attachment URLs")
    
    # Deletion
    deleted_by_sender: Mapped[bool] = mapped_column(Boolean, default=False)
    deleted_by_recipient: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Relationships
    parent_message: Mapped[Optional["Message"]] = relationship(
        "Message",
        remote_side="Message.id",
        backref="replies"
    )
    
    # Table Arguments
    __table_args__ = (
        Index('idx_message_sender', 'sender_id', 'created_at'),
        Index('idx_message_recipient', 'recipient_id', 'is_read'),
        Index('idx_message_thread', 'thread_id', 'created_at'),
        {'comment': 'Internal messaging system'}
    )
    
    # Validators
    @validates('message_type')
    def validate_message_type(self, key, value):
        valid_types = ['direct', 'broadcast', 'announcement', 'reply']
        if value.lower() not in valid_types:
            raise ValueError(f"Message type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('priority')
    def validate_priority(self, key, value):
        valid_priorities = ['low', 'normal', 'high', 'urgent']
        if value.lower() not in valid_priorities:
            raise ValueError(f"Priority must be one of: {', '.join(valid_priorities)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Message(id={self.id}, subject='{self.subject}', from='{self.sender_name}')>"

==================================================

FILE: notification.py
----------------------------------------
"""
Notification Model
System notifications and alerts
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Notification(BaseModel):
    """
    Notification model
    """
    
    __tablename__ = "notifications"
    
    # Notification Details
    title: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    message: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Type
    notification_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="info, warning, error, success, reminder, alert"
    )
    
    # Category
    category: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="appointment, payment, test_result, prescription, general, emergency"
    )
    
    # Recipient
    user_id: Mapped[Optional[int]] = mapped_column(Integer, index=True)
    recipient_email: Mapped[Optional[str]] = mapped_column(String(100))
    recipient_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Recipient Type
    recipient_type: Mapped[Optional[str]] = mapped_column(String(20), comment="patient, doctor, nurse, staff")
    
    # Delivery Channels
    send_email: Mapped[bool] = mapped_column(Boolean, default=True)
    send_sms: Mapped[bool] = mapped_column(Boolean, default=False)
    send_push: Mapped[bool] = mapped_column(Boolean, default=True)
    send_in_app: Mapped[bool] = mapped_column(Boolean, default=True)
    
    # Status
    is_read: Mapped[bool] = mapped_column(Boolean, default=False, index=True)
    read_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Sent Status
    email_sent: Mapped[bool] = mapped_column(Boolean, default=False)
    sms_sent: Mapped[bool] = mapped_column(Boolean, default=False)
    push_sent: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='normal',
        nullable=False,
        comment="low, normal, high, urgent"
    )
    
    # Action
    action_url: Mapped[Optional[str]] = mapped_column(String(500))
    action_text: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Reference
    reference_type: Mapped[Optional[str]] = mapped_column(String(50))
    reference_id: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Expiry
    expires_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Table Arguments
    __table_args__ = (
        Index('idx_notification_user', 'user_id', 'is_read'),
        Index('idx_notification_type', 'notification_type', 'priority'),
        Index('idx_notification_created', 'created_at', 'is_read'),
        {'comment': 'System notifications and alerts'}
    )
    
    # Validators
    @validates('notification_type')
    def validate_notification_type(self, key, value):
        valid_types = ['info', 'warning', 'error', 'success', 'reminder', 'alert']
        if value.lower() not in valid_types:
            raise ValueError(f"Notification type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('priority')
    def validate_priority(self, key, value):
        valid_priorities = ['low', 'normal', 'high', 'urgent']
        if value.lower() not in valid_priorities:
            raise ValueError(f"Priority must be one of: {', '.join(valid_priorities)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Notification(id={self.id}, title='{self.title}', type='{self.notification_type}')>"

==================================================

FILE: nurse.py
----------------------------------------
"""
Nurse Model
Nursing staff information and assignments
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
import re

from .base import BaseModel


class Nurse(BaseModel):
    """
    Nurse model for nursing staff management
    """
    
    __tablename__ = "nurses"
    
    # User Reference
    user_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("users.id", ondelete="CASCADE"),
        unique=True,
        index=True
    )
    
    # Basic Information
    nurse_id: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    first_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    middle_name: Mapped[Optional[str]] = mapped_column(String(100))
    last_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    
    # Professional Information
    qualification: Mapped[str] = mapped_column(String(200), nullable=False)
    nursing_license_number: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    license_expiry_date: Mapped[Optional[str]] = mapped_column(String(20))
    specialization: Mapped[Optional[str]] = mapped_column(String(100), index=True)
    
    # Experience
    years_of_experience: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Contact Information
    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    phone: Mapped[str] = mapped_column(String(20), nullable=False)
    alternate_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Hospital Assignment
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="SET NULL"),
        index=True
    )
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    
    # Work Details
    designation: Mapped[Optional[str]] = mapped_column(String(100))
    employee_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True, index=True)
    joining_date: Mapped[Optional[str]] = mapped_column(String(20))
    shift: Mapped[Optional[str]] = mapped_column(
        String(20),
        comment="morning, evening, night, rotating"
    )
    
    # Availability
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    is_on_duty: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, on_leave, resigned, retired, suspended"
    )
    
    # Emergency Contact
    emergency_contact_name: Mapped[Optional[str]] = mapped_column(String(200))
    emergency_contact_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Additional Information
    certifications: Mapped[Optional[str]] = mapped_column(Text)
    languages_spoken: Mapped[Optional[str]] = mapped_column(String(200))
    profile_image: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        back_populates="nurses"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        back_populates="nurses"
    )
    
    wards_managed: Mapped[List["Ward"]] = relationship(
        "Ward",
        back_populates="head_nurse",
        foreign_keys="Ward.head_nurse_id",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('years_of_experience >= 0', name='nurse_positive_experience'),
        Index('idx_nurse_name', 'first_name', 'last_name'),
        Index('idx_nurse_hospital', 'hospital_id', 'status'),
        Index('idx_nurse_department', 'department_id', 'status'),
        Index('idx_nurse_availability', 'is_available', 'is_on_duty'),
        {'comment': 'Nursing staff information and assignments'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        """Validate email format"""
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['active', 'on_leave', 'resigned', 'retired', 'suspended', 'inactive']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('shift')
    def validate_shift(self, key, value):
        """Validate shift"""
        if value:
            valid_shifts = ['morning', 'evening', 'night', 'rotating']
            if value.lower() not in valid_shifts:
                raise ValueError(f"Shift must be one of: {', '.join(valid_shifts)}")
            return value.lower()
        return value
    
    # Properties
    @property
    def full_name(self) -> str:
        """Get full name"""
        if self.middle_name:
            return f"{self.first_name} {self.middle_name} {self.last_name}"
        return f"{self.first_name} {self.last_name}"
    
    def __repr__(self) -> str:
        return f"<Nurse(id={self.id}, nurse_id='{self.nurse_id}', name='{self.full_name}')>"

==================================================

FILE: operation.py
----------------------------------------
"""
Operation Model
Surgical procedures and operation theater management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Operation(BaseModel):
    """
    Surgical operation/procedure model
    """
    
    __tablename__ = "operations"
    
    # Operation Details
    operation_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Admission
    admission_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("admissions.id", ondelete="SET NULL"),
        index=True
    )
    
    # Surgery Details
    surgery_name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    surgery_code: Mapped[Optional[str]] = mapped_column(String(50))
    surgery_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="elective, emergency, minor, major"
    )
    
    # Pre-operative Diagnosis
    pre_operative_diagnosis: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Post-operative Diagnosis
    post_operative_diagnosis: Mapped[Optional[str]] = mapped_column(Text)
    
    # Surgeons
    primary_surgeon_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    assistant_surgeons: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array")
    
    # Anesthesia
    anesthesiologist_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL")
    )
    anesthesia_type: Mapped[Optional[str]] = mapped_column(
        String(50),
        comment="general, spinal, epidural, local, sedation"
    )
    
    # Scheduling
    scheduled_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    scheduled_start_time: Mapped[str] = mapped_column(String(10), nullable=False)
    scheduled_end_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Actual Timing
    actual_start_time: Mapped[Optional[str]] = mapped_column(String(10))
    actual_end_time: Mapped[Optional[str]] = mapped_column(String(10))
    duration_minutes: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Operation Theater
    ot_number: Mapped[Optional[str]] = mapped_column(String(20))
    ot_floor: Mapped[Optional[int]] = mapped_column(Integer)  #  Floor reference
    
    # Procedure Details
    procedure_description: Mapped[Optional[str]] = mapped_column(Text)
    findings: Mapped[Optional[str]] = mapped_column(Text)
    complications: Mapped[Optional[str]] = mapped_column(Text)
    
    # Implants/Prosthetics
    implants_used: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array")
    
    # Blood
    blood_loss_ml: Mapped[Optional[int]] = mapped_column(Integer)
    blood_transfusion: Mapped[bool] = mapped_column(Boolean, default=False)
    blood_units_transfused: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='scheduled',
        nullable=False,
        index=True,
        comment="scheduled, in_progress, completed, cancelled, postponed"
    )
    
    # Priority
    priority: Mapped[str] = mapped_column(
        String(20),
        default='routine',
        nullable=False,
        comment="emergency, urgent, routine"
    )
    
    # Outcome
    outcome: Mapped[Optional[str]] = mapped_column(
        String(50),
        comment="successful, complicated, unsuccessful"
    )
    
    # Post-operative Care
    icu_required: Mapped[bool] = mapped_column(Boolean, default=False)
    ventilator_required: Mapped[bool] = mapped_column(Boolean, default=False)
    recovery_room: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Instructions
    post_op_instructions: Mapped[Optional[str]] = mapped_column(Text)
    discharge_instructions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Cost
    estimated_cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    actual_cost: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    
    # Consent
    consent_obtained: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    consent_document_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    operation_notes_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="operations"
    )
    
    admission: Mapped[Optional["Admission"]] = relationship(
        "Admission",
        backref="operations"
    )
    
    primary_surgeon: Mapped["Doctor"] = relationship(
        "Doctor",
        foreign_keys=[primary_surgeon_id],
        backref="surgeries_performed"
    )
    
    anesthesiologist: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        foreign_keys=[anesthesiologist_id],
        backref="anesthesia_provided"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('duration_minutes >= 0 OR duration_minutes IS NULL', name='operation_positive_duration'),
        CheckConstraint('blood_loss_ml >= 0 OR blood_loss_ml IS NULL', name='operation_positive_blood_loss'),
        CheckConstraint('blood_units_transfused >= 0 OR blood_units_transfused IS NULL', name='operation_positive_blood_units'),
        CheckConstraint('estimated_cost >= 0 OR estimated_cost IS NULL', name='operation_positive_estimated_cost'),
        CheckConstraint('actual_cost >= 0 OR actual_cost IS NULL', name='operation_positive_actual_cost'),
        Index('idx_operation_patient', 'patient_id', 'scheduled_date'),
        Index('idx_operation_surgeon', 'primary_surgeon_id', 'scheduled_date'),
        Index('idx_operation_date_status', 'scheduled_date', 'status'),
        {'comment': 'Surgical operations and procedures'}
    )
    
    # Validators
    @validates('surgery_type')
    def validate_surgery_type(self, key, value):
        valid_types = ['elective', 'emergency', 'minor', 'major', 'day_care']
        if value.lower() not in valid_types:
            raise ValueError(f"Surgery type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['scheduled', 'in_progress', 'completed', 'cancelled', 'postponed']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('priority')
    def validate_priority(self, key, value):
        valid_priorities = ['emergency', 'urgent', 'routine']
        if value.lower() not in valid_priorities:
            raise ValueError(f"Priority must be one of: {', '.join(valid_priorities)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Operation(id={self.id}, number='{self.operation_number}', surgery='{self.surgery_name}', status='{self.status}')>"

==================================================

FILE: patient.py
----------------------------------------
"""
Patient Model
Core patient information and medical records
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Date, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal
import re

from .base import BaseModel


class Patient(BaseModel):
    """
    Patient model for managing patient information
    """
    
    __tablename__ = "patients"
    
    # Basic Information
    patient_id: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    first_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    middle_name: Mapped[Optional[str]] = mapped_column(String(100))
    last_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    
    # Demographics
    date_of_birth: Mapped[str] = mapped_column(String(20), nullable=False)
    age: Mapped[int] = mapped_column(Integer, nullable=False)
    gender: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="male, female, other"
    )
    
    # Contact Information
    email: Mapped[Optional[str]] = mapped_column(String(100), index=True)
    phone: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    alternate_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Emergency Contact
    emergency_contact_name: Mapped[str] = mapped_column(String(200), nullable=False)
    emergency_contact_phone: Mapped[str] = mapped_column(String(20), nullable=False)
    emergency_contact_relation: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Medical Information
    blood_group: Mapped[Optional[str]] = mapped_column(
        String(5),
        index=True,
        comment="A+, A-, B+, B-, AB+, AB-, O+, O-"
    )
    height_cm: Mapped[Optional[Decimal]] = mapped_column(Numeric(5, 2))
    weight_kg: Mapped[Optional[Decimal]] = mapped_column(Numeric(5, 2))
    bmi: Mapped[Optional[Decimal]] = mapped_column(Numeric(4, 2))
    
    # Medical History
    allergies: Mapped[Optional[str]] = mapped_column(Text)
    chronic_diseases: Mapped[Optional[str]] = mapped_column(Text)
    current_medications: Mapped[Optional[str]] = mapped_column(Text)
    medical_history: Mapped[Optional[str]] = mapped_column(Text)
    family_medical_history: Mapped[Optional[str]] = mapped_column(Text)
    
    # Hospital Assignment
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="SET NULL"),
        index=True
    )
    primary_doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="SET NULL"),
        index=True
    )
    
    # Current Status
    current_bed_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("beds.id", ondelete="SET NULL")
    )
    is_admitted: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, index=True)
    admission_date: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Insurance
    has_insurance: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    insurance_provider: Mapped[Optional[str]] = mapped_column(String(200))
    insurance_policy_number: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Identification
    national_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True, index=True)
    passport_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, discharged, deceased, transferred"
    )
    
    # Additional Info
    occupation: Mapped[Optional[str]] = mapped_column(String(100))
    marital_status: Mapped[Optional[str]] = mapped_column(String(20))
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        back_populates="patients"
    )
    
    primary_doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        back_populates="patients",
        foreign_keys=[primary_doctor_id]
    )
    
    current_bed: Mapped[Optional["Bed"]] = relationship(
        "Bed",
        back_populates="current_patient",
        foreign_keys=[current_bed_id]
    )
    
    appointments: Mapped[List["Appointment"]] = relationship(
        "Appointment",
        back_populates="patient",
        lazy="dynamic"
    )
    
    admissions: Mapped[List["Admission"]] = relationship(
        "Admission",
        back_populates="patient",
        lazy="dynamic"
    )
    
    prescriptions: Mapped[List["Prescription"]] = relationship(
        "Prescription",
        back_populates="patient",
        lazy="dynamic"
    )
    
    lab_tests: Mapped[List["LabTest"]] = relationship(
        "LabTest",
        back_populates="patient",
        lazy="dynamic"
    )
    
    billings: Mapped[List["Billing"]] = relationship(
        "Billing",
        back_populates="patient",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('age >= 0 AND age <= 150', name='patient_valid_age'),
        CheckConstraint('height_cm > 0 OR height_cm IS NULL', name='patient_positive_height'),
        CheckConstraint('weight_kg > 0 OR weight_kg IS NULL', name='patient_positive_weight'),
        Index('idx_patient_name', 'first_name', 'last_name'),
        Index('idx_patient_hospital', 'hospital_id', 'status'),
        Index('idx_patient_doctor', 'primary_doctor_id'),
        Index('idx_patient_admitted', 'is_admitted', 'status'),
        {'comment': 'Patient information and medical records'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        """Validate email format"""
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('gender')
    def validate_gender(self, key, value):
        """Validate gender"""
        valid_genders = ['male', 'female', 'other']
        if value.lower() not in valid_genders:
            raise ValueError(f"Gender must be one of: {', '.join(valid_genders)}")
        return value.lower()
    
    @validates('blood_group')
    def validate_blood_group(self, key, value):
        """Validate blood group"""
        if value:
            valid_groups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-']
            if value.upper() not in valid_groups:
                raise ValueError(f"Blood group must be one of: {', '.join(valid_groups)}")
            return value.upper()
        return value
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['active', 'discharged', 'deceased', 'transferred', 'inactive']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    # Properties
    @property
    def full_name(self) -> str:
        """Get full name"""
        if self.middle_name:
            return f"{self.first_name} {self.middle_name} {self.last_name}"
        return f"{self.first_name} {self.last_name}"
    
    @property
    def full_address(self) -> str:
        """Get complete address"""
        return f"{self.address}, {self.city}, {self.state} {self.pincode}, {self.country}"
    
    def calculate_bmi(self) -> Optional[Decimal]:
        """Calculate BMI from height and weight"""
        if self.height_cm and self.weight_kg:
            height_m = self.height_cm / 100
            bmi = self.weight_kg / (height_m ** 2)
            self.bmi = round(bmi, 2)
            return self.bmi
        return None
    
    def __repr__(self) -> str:
        return f"<Patient(id={self.id}, patient_id='{self.patient_id}', name='{self.full_name}')>"

==================================================

FILE: payment.py
----------------------------------------
"""
Payment Model
Payment transactions and receipts
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Payment(BaseModel):
    """
    Payment transaction model
    """
    
    __tablename__ = "payments"
    
    # Payment Details
    payment_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    receipt_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    payment_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    payment_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Billing Reference
    billing_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("billings.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Payment Amount
    amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Payment Method
    payment_method: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="cash, card, upi, net_banking, cheque, insurance, wallet"
    )
    
    # Payment Details (based on method)
    transaction_id: Mapped[Optional[str]] = mapped_column(String(100), unique=True, index=True)
    card_number: Mapped[Optional[str]] = mapped_column(String(20), comment="Last 4 digits")
    card_type: Mapped[Optional[str]] = mapped_column(String(20), comment="visa, mastercard, amex")
    cheque_number: Mapped[Optional[str]] = mapped_column(String(50))
    cheque_date: Mapped[Optional[str]] = mapped_column(String(20))
    bank_name: Mapped[Optional[str]] = mapped_column(String(200))
    upi_id: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='completed',
        nullable=False,
        index=True,
        comment="completed, pending, failed, refunded, cancelled"
    )
    
    # Refund Details
    is_refunded: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    refund_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    refund_date: Mapped[Optional[str]] = mapped_column(String(20))
    refund_reason: Mapped[Optional[str]] = mapped_column(Text)
    
    # Received By
    received_by: Mapped[str] = mapped_column(String(200), nullable=False)
    
    # Notes
    payment_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Receipt
    receipt_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    billing: Mapped["Billing"] = relationship(
        "Billing",
        back_populates="payments"
    )
    
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="payments"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('amount > 0', name='payment_positive_amount'),
        CheckConstraint('refund_amount >= 0 OR refund_amount IS NULL', name='payment_positive_refund'),
        Index('idx_payment_billing', 'billing_id', 'payment_date'),
        Index('idx_payment_patient', 'patient_id', 'payment_date'),
        Index('idx_payment_method', 'payment_method', 'status'),
        Index('idx_payment_date_status', 'payment_date', 'status'),
        {'comment': 'Payment transactions and receipts'}
    )
    
    # Validators
    @validates('payment_method')
    def validate_payment_method(self, key, value):
        valid_methods = [
            'cash', 'card', 'credit_card', 'debit_card', 'upi',
            'net_banking', 'cheque', 'insurance', 'wallet', 'online'
        ]
        if value.lower() not in valid_methods:
            raise ValueError(f"Payment method must be one of: {', '.join(valid_methods)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['completed', 'pending', 'failed', 'refunded', 'cancelled', 'processing']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Payment(id={self.id}, number='{self.payment_number}', amount={self.amount}, method='{self.payment_method}')>"

==================================================

FILE: payroll.py
----------------------------------------
"""
Payroll Model
Staff salary and payroll management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Payroll(BaseModel):
    """
    Payroll model
    """
    
    __tablename__ = "payrolls"
    
    # Payroll Details
    payroll_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Period
    month: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    year: Mapped[int] = mapped_column(Integer, nullable=False, index=True)
    pay_period_start: Mapped[str] = mapped_column(String(20), nullable=False)
    pay_period_end: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Employee Reference
    staff_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="CASCADE"),
        index=True
    )
    doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        index=True
    )
    nurse_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("nurses.id", ondelete="CASCADE"),
        index=True
    )
    
    # Employee Info
    employee_name: Mapped[str] = mapped_column(String(200), nullable=False)
    employee_id: Mapped[str] = mapped_column(String(50), nullable=False, index=True)
    designation: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Salary Components
    basic_salary: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    hra: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'), comment="House Rent Allowance")
    medical_allowance: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    transport_allowance: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    other_allowances: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    
    # Overtime
    overtime_hours: Mapped[int] = mapped_column(Integer, default=0)
    overtime_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    
    # Bonuses & Incentives
    bonus: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    incentives: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    
    # Gross Salary
    gross_salary: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Deductions
    pf_deduction: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'), comment="Provident Fund")
    esi_deduction: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'), comment="Employee State Insurance")
    tax_deduction: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    loan_deduction: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    advance_deduction: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    other_deductions: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    
    # Total Deductions
    total_deductions: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    
    # Net Salary
    net_salary: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Attendance
    working_days: Mapped[int] = mapped_column(Integer, nullable=False)
    present_days: Mapped[int] = mapped_column(Integer, nullable=False)
    absent_days: Mapped[int] = mapped_column(Integer, default=0)
    leave_days: Mapped[int] = mapped_column(Integer, default=0)
    paid_leaves: Mapped[int] = mapped_column(Integer, default=0)
    unpaid_leaves: Mapped[int] = mapped_column(Integer, default=0)
    
    # Payment
    payment_date: Mapped[Optional[str]] = mapped_column(String(20))
    payment_method: Mapped[Optional[str]] = mapped_column(String(50), comment="bank_transfer, cash, cheque")
    transaction_id: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, processed, paid, on_hold"
    )
    
    # Bank Details (snapshot)
    bank_name: Mapped[Optional[str]] = mapped_column(String(200))
    account_number: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Approval
    approved_by: Mapped[Optional[str]] = mapped_column(String(200))
    approval_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Payslip
    payslip_url: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    staff: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        backref="payrolls"
    )
    
    doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        backref="payrolls"
    )
    
    nurse: Mapped[Optional["Nurse"]] = relationship(
        "Nurse",
        backref="payrolls"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('month >= 1 AND month <= 12', name='payroll_valid_month'),
        CheckConstraint('year >= 2000 AND year <= 2100', name='payroll_valid_year'),
        CheckConstraint('basic_salary >= 0', name='payroll_positive_basic_salary'),
        CheckConstraint('gross_salary >= 0', name='payroll_positive_gross_salary'),
        CheckConstraint('net_salary >= 0', name='payroll_positive_net_salary'),
        CheckConstraint('working_days > 0', name='payroll_positive_working_days'),
        CheckConstraint('present_days >= 0', name='payroll_positive_present_days'),
        Index('idx_payroll_employee', 'employee_id', 'month', 'year'),
        Index('idx_payroll_period', 'month', 'year', 'status'),
        {'comment': 'Staff salary and payroll management'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['pending', 'processed', 'paid', 'on_hold', 'cancelled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Payroll(id={self.id}, employee='{self.employee_name}', period={self.month}/{self.year}, net={self.net_salary})>"

==================================================

FILE: pharmacy.py
----------------------------------------
"""
Pharmacy Model
Pharmacy transactions and medicine dispensing
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Pharmacy(BaseModel):
    """
    Pharmacy transaction model
    """
    
    __tablename__ = "pharmacies"
    
    # Transaction Details
    transaction_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    transaction_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    transaction_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Prescription Reference
    prescription_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("prescriptions.id", ondelete="SET NULL"),
        index=True
    )
    
    # Patient
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Medicine Details (JSON format for multiple medicines)
    medicines_dispensed: Mapped[str] = mapped_column(Text, nullable=False, comment="JSON array")
    
    # Dispensed By
    dispensed_by: Mapped[str] = mapped_column(String(200), nullable=False)
    pharmacist_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("staffs.id", ondelete="SET NULL")
    )
    
    # Financial
    total_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    discount_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    final_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    
    # Payment
    payment_status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, paid, partially_paid, insurance_claimed"
    )
    payment_method: Mapped[Optional[str]] = mapped_column(
        String(50),
        comment="cash, card, insurance, online"
    )
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='completed',
        nullable=False,
        index=True,
        comment="completed, cancelled, returned, partially_returned"
    )
    
    # Return/Refund
    is_returned: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    return_date: Mapped[Optional[str]] = mapped_column(String(20))
    return_reason: Mapped[Optional[str]] = mapped_column(Text)
    refund_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    prescription: Mapped[Optional["Prescription"]] = relationship(
        "Prescription",
        backref="pharmacy_transactions"
    )
    
    patient: Mapped["Patient"] = relationship(
        "Patient",
        backref="pharmacy_transactions"
    )
    
    pharmacist: Mapped[Optional["Staff"]] = relationship(
        "Staff",
        backref="pharmacy_transactions"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_amount >= 0', name='pharmacy_positive_total'),
        CheckConstraint('discount_amount >= 0', name='pharmacy_positive_discount'),
        CheckConstraint('final_amount >= 0', name='pharmacy_positive_final'),
        Index('idx_pharmacy_patient', 'patient_id', 'transaction_date'),
        Index('idx_pharmacy_prescription', 'prescription_id'),
        Index('idx_pharmacy_payment', 'payment_status', 'status'),
        {'comment': 'Pharmacy transactions and medicine dispensing'}
    )
    
    # Validators
    @validates('payment_status')
    def validate_payment_status(self, key, value):
        valid_statuses = ['pending', 'paid', 'partially_paid', 'insurance_claimed', 'refunded']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Payment status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['completed', 'cancelled', 'returned', 'partially_returned']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Pharmacy(id={self.id}, number='{self.transaction_number}', amount={self.final_amount})>"

==================================================

FILE: prescription.py
----------------------------------------
"""
Prescription Model
Doctor prescriptions for patients
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Table
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel
from app.core.database import Base


# Association table for prescription-medicine many-to-many relationship
prescription_medicines = Table(
    'prescription_medicines',
    Base.metadata,
    Column('prescription_id', Integer, ForeignKey('prescriptions.id', ondelete='CASCADE'), primary_key=True),
    Column('medicine_id', Integer, ForeignKey('medicines.id', ondelete='CASCADE'), primary_key=True),
    Column('dosage', String(100), nullable=False),
    Column('frequency', String(100), nullable=False),
    Column('duration', String(50), nullable=False),
    Column('quantity', Integer, nullable=False),
    Column('instructions', Text),
    Column('created_at', String(50)),
    Index('idx_prescription_medicine', 'prescription_id', 'medicine_id')
)


class Prescription(BaseModel):
    """
    Medical prescription model
    """
    
    __tablename__ = "prescriptions"
    
    # Prescription Details
    prescription_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    prescription_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Patient and Doctor
    patient_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    doctor_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Related Appointment/Admission
    appointment_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("appointments.id", ondelete="SET NULL"),
        index=True
    )
    admission_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("admissions.id", ondelete="SET NULL")
    )
    
    # Diagnosis
    diagnosis: Mapped[str] = mapped_column(Text, nullable=False)
    symptoms: Mapped[Optional[str]] = mapped_column(Text)
    
    # Prescription Type
    prescription_type: Mapped[str] = mapped_column(
        String(50),
        default='outpatient',
        nullable=False,
        comment="outpatient, inpatient, emergency, followup"
    )
    
    # Vital Signs (at time of prescription)
    temperature: Mapped[Optional[str]] = mapped_column(String(10))
    blood_pressure: Mapped[Optional[str]] = mapped_column(String(20))
    pulse_rate: Mapped[Optional[str]] = mapped_column(String(10))
    respiratory_rate: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Instructions
    general_instructions: Mapped[Optional[str]] = mapped_column(Text)
    dietary_advice: Mapped[Optional[str]] = mapped_column(Text)
    precautions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Follow-up
    follow_up_required: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    follow_up_date: Mapped[Optional[str]] = mapped_column(String(20))
    follow_up_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Lab Tests Recommended
    lab_tests_recommended: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array")
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, completed, cancelled, expired"
    )
    
    # Validity
    valid_until: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Digital Signature
    digital_signature: Mapped[Optional[str]] = mapped_column(String(500))
    is_verified: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Dispensed Status
    is_dispensed: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    dispensed_by: Mapped[Optional[str]] = mapped_column(String(100))
    dispensed_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Notes
    doctor_notes: Mapped[Optional[str]] = mapped_column(Text)
    pharmacy_notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped["Patient"] = relationship(
        "Patient",
        back_populates="prescriptions"
    )
    
    doctor: Mapped["Doctor"] = relationship(
        "Doctor",
        back_populates="prescriptions"
    )
    
    appointment: Mapped[Optional["Appointment"]] = relationship(
        "Appointment",
        backref="prescriptions"
    )
    
    medicines: Mapped[List["Medicine"]] = relationship(
        "Medicine",
        secondary=prescription_medicines,
        back_populates="prescriptions",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        Index('idx_prescription_patient', 'patient_id', 'prescription_date'),
        Index('idx_prescription_doctor', 'doctor_id', 'prescription_date'),
        Index('idx_prescription_status', 'status', 'is_dispensed'),
        {'comment': 'Medical prescriptions with medicine details'}
    )
    
    # Validators
    @validates('prescription_type')
    def validate_prescription_type(self, key, value):
        valid_types = ['outpatient', 'inpatient', 'emergency', 'followup', 'discharge']
        if value.lower() not in valid_types:
            raise ValueError(f"Prescription type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'completed', 'cancelled', 'expired', 'partially_dispensed']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Prescription(id={self.id}, number='{self.prescription_number}', patient_id={self.patient_id})>"

==================================================

FILE: procedure.py
----------------------------------------
"""
 Procedure model
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Procedure(Base):
    __tablename__ = "procedures"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    doctor_id = Column(Integer, ForeignKey("doctors.id", ondelete="CASCADE"), nullable=False)
    
    name = Column(String, nullable=False)
    description = Column(String, nullable=True)
    procedure_date = Column(DateTime, nullable=False)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    #  Relationships
    patient = relationship("Patient", back_populates="procedures")
    doctor = relationship("Doctor", back_populates="procedures")

==================================================

FILE: purchase_order.py
----------------------------------------
"""
Purchase Order Model
Purchase orders for inventory and supplies
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class PurchaseOrder(BaseModel):
    """
    Purchase order model
    """
    
    __tablename__ = "purchase_orders"
    
    # PO Details
    po_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    po_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Supplier
    supplier_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("suppliers.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Items (JSON format)
    items: Mapped[str] = mapped_column(Text, nullable=False, comment="JSON array of items")
    
    # Financial
    subtotal: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), default=Decimal('0.00'))
    shipping_cost: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    discount_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    total_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Delivery
    expected_delivery_date: Mapped[Optional[str]] = mapped_column(String(20))
    actual_delivery_date: Mapped[Optional[str]] = mapped_column(String(20))
    delivery_address: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        index=True,
        comment="pending, approved, rejected, ordered, partially_received, received, cancelled"
    )
    
    # Payment
    payment_status: Mapped[str] = mapped_column(
        String(20),
        default='pending',
        nullable=False,
        comment="pending, partial, paid"
    )
    payment_terms: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Approval
    requested_by: Mapped[str] = mapped_column(String(200), nullable=False)
    approved_by: Mapped[Optional[str]] = mapped_column(String(200))
    approved_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    terms_conditions: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    supplier: Mapped["Supplier"] = relationship(
        "Supplier",
        back_populates="purchase_orders"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('subtotal >= 0', name='po_positive_subtotal'),
        CheckConstraint('tax_amount >= 0', name='po_positive_tax'),
        CheckConstraint('total_amount >= 0', name='po_positive_total'),
        Index('idx_po_supplier', 'supplier_id', 'po_date'),
        Index('idx_po_status', 'status', 'payment_status'),
        {'comment': 'Purchase orders for inventory and supplies'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = [
            'pending', 'approved', 'rejected', 'ordered',
            'partially_received', 'received', 'cancelled'
        ]
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('payment_status')
    def validate_payment_status(self, key, value):
        valid_statuses = ['pending', 'partial', 'paid']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Payment status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<PurchaseOrder(id={self.id}, number='{self.po_number}', amount={self.total_amount})>"

==================================================

FILE: radiology.py
----------------------------------------
"""
 Radiology model
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Radiology(Base):
    __tablename__ = "radiology"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    doctor_id = Column(Integer, ForeignKey("doctors.id", ondelete="CASCADE"), nullable=False)
    
    report_file = Column(String, nullable=True)
    imaging_type = Column(String, nullable=False)  # X-Ray, MRI, CT Scan, Ultrasound
    date_taken = Column(DateTime, nullable=False)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    #  Relationships
    patient = relationship("Patient")
    doctor = relationship("Doctor", back_populates="radiology_records")

==================================================

FILE: revenue.py
----------------------------------------
"""
Revenue Model
Hospital revenue and income tracking
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional
from decimal import Decimal

from .base import BaseModel


class Revenue(BaseModel):
    """
    Revenue tracking model
    """
    
    __tablename__ = "revenues"
    
    # Revenue Details
    revenue_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    revenue_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Source
    revenue_source: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="consultations, procedures, pharmacy, lab, imaging, room_charges, miscellaneous"
    )
    
    # Description
    description: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Amount
    amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    tax_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    discount_amount: Mapped[Decimal] = mapped_column(Numeric(10, 2), default=Decimal('0.00'))
    net_amount: Mapped[Decimal] = mapped_column(Numeric(12, 2), nullable=False)
    
    # Patient (if applicable)
    patient_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("patients.id", ondelete="SET NULL"),
        index=True
    )
    
    # Related Records
    billing_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("billings.id", ondelete="SET NULL")
    )
    payment_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("payments.id", ondelete="SET NULL")
    )
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    
    # Payment Method
    payment_method: Mapped[str] = mapped_column(String(50), nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='received',
        nullable=False,
        comment="received, pending, refunded"
    )
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    patient: Mapped[Optional["Patient"]] = relationship(
        "Patient",
        backref="revenues"
    )
    
    billing: Mapped[Optional["Billing"]] = relationship(
        "Billing",
        backref="revenues"
    )
    
    payment: Mapped[Optional["Payment"]] = relationship(
        "Payment",
        backref="revenues"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="revenues"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('amount > 0', name='revenue_positive_amount'),
        CheckConstraint('tax_amount >= 0', name='revenue_positive_tax'),
        CheckConstraint('discount_amount >= 0', name='revenue_positive_discount'),
        CheckConstraint('net_amount >= 0', name='revenue_positive_net'),
        Index('idx_revenue_source', 'revenue_source', 'revenue_date'),
        Index('idx_revenue_patient', 'patient_id', 'revenue_date'),
        Index('idx_revenue_department', 'department_id', 'revenue_date'),
        {'comment': 'Hospital revenue and income tracking'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['received', 'pending', 'refunded', 'cancelled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Revenue(id={self.id}, number='{self.revenue_number}', amount={self.net_amount})>"
    

==================================================

FILE: role.py
----------------------------------------
"""
Role Model
User roles and access control
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Role(BaseModel):
    """
    User role model
    """
    
    __tablename__ = "roles"
    
    # Role Details
    name: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    code: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    
    # Description
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Role Type
    role_type: Mapped[str] = mapped_column(
        String(50),
        default='custom',
        nullable=False,
        comment="system, custom"
    )
    
    # Level (hierarchy)
    level: Mapped[int] = mapped_column(Integer, default=0, comment="Higher number = more privileges")
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, inactive"
    )
    
    # Permissions Summary
    permissions: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array of permission codes")
    
    # Default for User Type
    is_default_for: Mapped[Optional[str]] = mapped_column(String(50), comment="doctor, nurse, patient, staff, admin")
    
    # Relationships
    role_permissions: Mapped[List["RolePermission"]] = relationship(
        "RolePermission",
        back_populates="role",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        Index('idx_role_type', 'role_type', 'status'),
        {'comment': 'User roles and access control'}
    )
    
    # Validators
    @validates('role_type')
    def validate_role_type(self, key, value):
        valid_types = ['system', 'custom']
        if value.lower() not in valid_types:
            raise ValueError(f"Role type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'inactive']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Role(id={self.id}, name='{self.name}', code='{self.code}')>"

==================================================

FILE: role_permission.py
----------------------------------------
"""
Role Permission Model
Role-based permissions mapping
"""

from sqlalchemy import Column, Integer, String, Boolean, ForeignKey, Index, UniqueConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class RolePermission(BaseModel):
    """
    Role permission mapping model
    """
    
    __tablename__ = "role_permissions"
    
    # Role
    role_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("roles.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Permission Details
    resource: Mapped[str] = mapped_column(String(100), nullable=False, index=True, comment="patients, appointments, billing, etc.")
    action: Mapped[str] = mapped_column(String(50), nullable=False, comment="create, read, update, delete, list")
    
    # Permission Code (composite)
    permission_code: Mapped[str] = mapped_column(String(200), nullable=False, index=True, comment="resource:action e.g., patients:create")
    
    # Granted
    is_granted: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    
    # Conditions (optional)
    conditions: Mapped[Optional[str]] = mapped_column(String(500), comment="JSON conditions for permission")
    
    # Relationships
    role: Mapped["Role"] = relationship(
        "Role",
        back_populates="role_permissions"
    )
    
    # Table Arguments
    __table_args__ = (
        UniqueConstraint('role_id', 'permission_code', name='unique_role_permission'),
        Index('idx_rolepermission_role', 'role_id', 'resource'),
        Index('idx_rolepermission_code', 'permission_code', 'is_granted'),
        {'comment': 'Role-based permissions mapping'}
    )
    
    # Validators
    @validates('action')
    def validate_action(self, key, value):
        valid_actions = ['create', 'read', 'update', 'delete', 'list', 'export', 'approve', 'reject']
        if value.lower() not in valid_actions:
            raise ValueError(f"Action must be one of: {', '.join(valid_actions)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<RolePermission(role_id={self.role_id}, permission='{self.permission_code}')>"

==================================================

FILE: room.py
----------------------------------------
"""
Room Model - Updated with Floor Reference
Hospital rooms with comprehensive floor location
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal

from .base import BaseModel


class Room(BaseModel):
    """
    Room model with floor reference
    Manages hospital rooms across different floors
    """
    
    __tablename__ = "rooms"
    
    # Basic Information
    room_number: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    room_name: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Room Type
    room_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="general, private, semi_private, icu, operation, emergency, consultation, observation, isolation"
    )
    
    #  Floor Reference - NEW
    floor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("floors.id", ondelete="SET NULL"),
        nullable=True,
        index=True
    )
    floor_number: Mapped[Optional[int]] = mapped_column(Integer, nullable=True, index=True)
    
    # Location
    ward_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("wards.id", ondelete="SET NULL"),
        index=True
    )
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    building: Mapped[Optional[str]] = mapped_column(String(50))
    wing: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Capacity
    bed_capacity: Mapped[int] = mapped_column(Integer, default=1, nullable=False)
    current_occupancy: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Room Specifications
    size_sqft: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    has_attached_bathroom: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_ac: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_window: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_balcony: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_tv: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_telephone: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_refrigerator: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Medical Equipment
    has_oxygen_supply: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_suction: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_monitor: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_ventilator: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Availability
    status: Mapped[str] = mapped_column(
        String(20),
        default='available',
        nullable=False,
        index=True,
        comment="available, occupied, maintenance, reserved, cleaning, under_renovation"
    )
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False, index=True)
    is_isolation_room: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Pricing
    price_per_day: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    deposit_amount: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2))
    
    # Additional Info
    description: Mapped[Optional[str]] = mapped_column(Text)
    special_equipment: Mapped[Optional[str]] = mapped_column(Text)
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Housekeeping
    last_cleaned_at: Mapped[Optional[str]] = mapped_column(String(50))
    last_maintenance_at: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Relationships
    floor: Mapped[Optional["Floor"]] = relationship(
        "Floor",
        back_populates="rooms",
        foreign_keys=[floor_id]
    )
    
    ward: Mapped[Optional["Ward"]] = relationship(
        "Ward",
        back_populates="rooms"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        back_populates="rooms"
    )
    
    beds: Mapped[List["Bed"]] = relationship(
        "Bed",
        back_populates="room",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    admissions: Mapped[List["Admission"]] = relationship(
        "Admission",
        back_populates="room",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('bed_capacity >= 1', name='room_min_one_bed'),
        CheckConstraint('current_occupancy >= 0', name='room_positive_occupancy'),
        CheckConstraint('current_occupancy <= bed_capacity', name='room_occupancy_not_exceed_capacity'),
        CheckConstraint('size_sqft > 0 OR size_sqft IS NULL', name='room_positive_size'),
        CheckConstraint('price_per_day >= 0 OR price_per_day IS NULL', name='room_positive_price'),
        Index('idx_room_floor', 'floor_id', 'floor_number'),
        Index('idx_room_ward', 'ward_id', 'status'),
        Index('idx_room_department', 'department_id'),
        Index('idx_room_type_status', 'room_type', 'status'),
        Index('idx_room_availability', 'is_available', 'status'),
        {'comment': 'Hospital rooms with floor locations and facilities'}
    )
    
    # Validators
    @validates('room_type')
    def validate_room_type(self, key, value):
        """Validate room type"""
        valid_types = [
            'general', 'private', 'semi_private', 'icu', 'operation',
            'emergency', 'consultation', 'observation', 'isolation',
            'labor', 'recovery', 'nicu', 'pediatric'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Room type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = [
            'available', 'occupied', 'maintenance', 'reserved',
            'cleaning', 'under_renovation', 'quarantine'
        ]
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('current_occupancy')
    def validate_current_occupancy(self, key, value):
        """Ensure occupancy doesn't exceed capacity"""
        if value > self.bed_capacity:
            raise ValueError("Current occupancy cannot exceed bed capacity")
        return value
    
    # Properties
    @property
    def available_beds(self) -> int:
        """Calculate available beds"""
        return max(0, self.bed_capacity - self.current_occupancy)
    
    @property
    def is_full(self) -> bool:
        """Check if room is at full capacity"""
        return self.current_occupancy >= self.bed_capacity
    
    @property
    def occupancy_rate(self) -> float:
        """Calculate occupancy percentage"""
        if self.bed_capacity == 0:
            return 0.0
        return round((self.current_occupancy / self.bed_capacity) * 100, 2)
    
    @property
    def floor_display(self) -> str:
        """Get floor display name"""
        if self.floor_number is None:
            return "N/A"
        elif self.floor_number == 0:
            return "Ground Floor"
        elif self.floor_number < 0:
            return f"Basement {abs(self.floor_number)}"
        elif self.floor_number == 1:
            return "1st Floor"
        elif self.floor_number == 2:
            return "2nd Floor"
        elif self.floor_number == 3:
            return "3rd Floor"
        else:
            return f"{self.floor_number}th Floor"
    
    def __repr__(self) -> str:
        floor_info = f", floor={self.floor_number}" if self.floor_number is not None else ""
        return f"<Room(id={self.id}, number='{self.room_number}'{floor_info}, type='{self.room_type}')>"


==================================================

FILE: schedule.py
----------------------------------------
"""
Schedule Model
Staff work schedule and roster
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Schedule(BaseModel):
    """
    Staff schedule/roster model
    """
    
    __tablename__ = "schedules"
    
    # Schedule Details
    schedule_date: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    
    # Doctor
    doctor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("doctors.id", ondelete="CASCADE"),
        index=True
    )
    
    # Shift
    shift_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("shifts.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )
    
    # Department
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL")
    )
    
    # Timing (can override shift timings)
    start_time: Mapped[Optional[str]] = mapped_column(String(10))
    end_time: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Availability
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    max_appointments: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='scheduled',
        nullable=False,
        index=True,
        comment="scheduled, completed, cancelled, on_leave"
    )
    
    # Day Type
    day_type: Mapped[str] = mapped_column(
        String(20),
        default='working',
        nullable=False,
        comment="working, holiday, weekend, on_call"
    )
    
    # On-Call
    is_on_call: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    doctor: Mapped[Optional["Doctor"]] = relationship(
        "Doctor",
        back_populates="schedules"
    )
    
    shift: Mapped["Shift"] = relationship(
        "Shift",
        back_populates="schedules"
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        backref="schedules"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('max_appointments >= 0 OR max_appointments IS NULL', name='schedule_positive_max_appointments'),
        Index('idx_schedule_doctor_date', 'doctor_id', 'schedule_date'),
        Index('idx_schedule_shift', 'shift_id', 'schedule_date'),
        Index('idx_schedule_date_status', 'schedule_date', 'status'),
        {'comment': 'Staff work schedules and rosters'}
    )
    
    # Validators
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['scheduled', 'completed', 'cancelled', 'on_leave', 'rescheduled']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('day_type')
    def validate_day_type(self, key, value):
        valid_types = ['working', 'holiday', 'weekend', 'on_call']
        if value.lower() not in valid_types:
            raise ValueError(f"Day type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Schedule(id={self.id}, date='{self.schedule_date}', doctor_id={self.doctor_id})>"

==================================================

FILE: setting.py
----------------------------------------
"""
Setting Model
System configuration and settings
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional

from .base import BaseModel


class Setting(BaseModel):
    """
    System settings model
    """
    
    __tablename__ = "settings"
    
    # Setting Key
    setting_key: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    
    # Setting Value
    setting_value: Mapped[str] = mapped_column(Text, nullable=False)
    
    # Data Type
    data_type: Mapped[str] = mapped_column(
        String(20),
        default='string',
        nullable=False,
        comment="string, integer, boolean, json, float"
    )
    
    # Category
    category: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="general, email, sms, payment, notification, security, appearance"
    )
    
    # Description
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Is Sensitive (passwords, API keys, etc.)
    is_sensitive: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Is Editable
    is_editable: Mapped[bool] = mapped_column(Boolean, default=True)
    
    # Default Value
    default_value: Mapped[Optional[str]] = mapped_column(Text)
    
    # Validation Rules
    validation_rules: Mapped[Optional[str]] = mapped_column(Text, comment="JSON format")
    
    # Last Modified By
    modified_by: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Table Arguments
    __table_args__ = (
        Index('idx_setting_category', 'category'),
        {'comment': 'System configuration and settings'}
    )
    
    # Validators
    @validates('data_type')
    def validate_data_type(self, key, value):
        valid_types = ['string', 'integer', 'boolean', 'json', 'float', 'array']
        if value.lower() not in valid_types:
            raise ValueError(f"Data type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('category')
    def validate_category(self, key, value):
        valid_categories = [
            'general', 'email', 'sms', 'payment', 'notification',
            'security', 'appearance', 'appointment', 'billing', 'system'
        ]
        if value.lower() not in valid_categories:
            raise ValueError(f"Category must be one of: {', '.join(valid_categories)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Setting(key='{self.setting_key}', category='{self.category}')>"

==================================================

FILE: shift.py
----------------------------------------
"""
Shift Model
Work shift definitions
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint, Time
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Shift(BaseModel):
    """
    Work shift model
    """
    
    __tablename__ = "shifts"
    
    # Shift Details
    shift_name: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    shift_code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Timing
    start_time: Mapped[str] = mapped_column(String(10), nullable=False)
    end_time: Mapped[str] = mapped_column(String(10), nullable=False)
    
    # Duration
    duration_hours: Mapped[int] = mapped_column(Integer, nullable=False, comment="in hours")
    
    # Break Time
    break_duration_minutes: Mapped[int] = mapped_column(Integer, default=30, comment="in minutes")
    
    # Shift Type
    shift_type: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        comment="morning, evening, night, general, rotating"
    )
    
    # Days
    applicable_days: Mapped[Optional[str]] = mapped_column(String(100), comment="JSON array: Mon, Tue, etc.")
    
    # Late/Early Grace Period
    grace_period_minutes: Mapped[int] = mapped_column(Integer, default=15)
    
    # Overtime
    overtime_applicable: Mapped[bool] = mapped_column(Boolean, default=True)
    overtime_rate_multiplier: Mapped[Optional[float]] = mapped_column(Integer, default=1.5)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, inactive"
    )
    
    # Description
    description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    schedules: Mapped[List["Schedule"]] = relationship(
        "Schedule",
        back_populates="shift",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('duration_hours > 0', name='shift_positive_duration'),
        CheckConstraint('break_duration_minutes >= 0', name='shift_positive_break'),
        CheckConstraint('grace_period_minutes >= 0', name='shift_positive_grace'),
        {'comment': 'Work shift definitions'}
    )
    
    # Validators
    @validates('shift_type')
    def validate_shift_type(self, key, value):
        valid_types = ['morning', 'evening', 'night', 'general', 'rotating', 'split']
        if value.lower() not in valid_types:
            raise ValueError(f"Shift type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'inactive']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Shift(id={self.id}, name='{self.shift_name}', time='{self.start_time}-{self.end_time}')>"

==================================================

FILE: staff.py
----------------------------------------
"""
Staff Model
Administrative and support staff management
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
from decimal import Decimal
import re

from .base import BaseModel


class Staff(BaseModel):
    """
    Staff model for administrative and support personnel
    """
    
    __tablename__ = "staffs"
    
    # User Reference
    user_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("users.id", ondelete="CASCADE"),
        unique=True,
        index=True
    )
    
    # Basic Information
    staff_id: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    first_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    middle_name: Mapped[Optional[str]] = mapped_column(String(100))
    last_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    
    # Contact Information
    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    phone: Mapped[str] = mapped_column(String(20), nullable=False)
    alternate_phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Employment Details
    employee_id: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    designation: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    department: Mapped[Optional[str]] = mapped_column(String(100), index=True)
    role: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="receptionist, accountant, hr, admin, security, housekeeping, lab_technician, pharmacist"
    )
    
    # Hospital Assignment
    hospital_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("hospitals.id", ondelete="SET NULL"),
        index=True
    )
    
    # Work Details
    joining_date: Mapped[str] = mapped_column(String(20), nullable=False)
    leaving_date: Mapped[Optional[str]] = mapped_column(String(20))
    shift: Mapped[Optional[str]] = mapped_column(
        String(20),
        comment="morning, evening, night, rotating, general"
    )
    
    # Salary
    salary: Mapped[Optional[Decimal]] = mapped_column(Numeric(12, 2))
    salary_currency: Mapped[str] = mapped_column(String(3), default="USD")
    
    # Qualifications
    qualification: Mapped[str] = mapped_column(String(200), nullable=False)
    experience_years: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Availability
    is_available: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    is_on_duty: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, on_leave, resigned, terminated, retired"
    )
    
    # Emergency Contact
    emergency_contact_name: Mapped[Optional[str]] = mapped_column(String(200))
    emergency_contact_phone: Mapped[Optional[str]] = mapped_column(String(20))
    emergency_contact_relation: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Identification
    national_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True)
    
    # Additional Information
    skills: Mapped[Optional[str]] = mapped_column(Text)
    certifications: Mapped[Optional[str]] = mapped_column(Text)
    languages_spoken: Mapped[Optional[str]] = mapped_column(String(200))
    notes: Mapped[Optional[str]] = mapped_column(Text)
    profile_image: Mapped[Optional[str]] = mapped_column(String(500))
    
    # Relationships
    hospital: Mapped[Optional["Hospital"]] = relationship(
        "Hospital",
        backref="staff_members"
    )
    
    attendances: Mapped[List["Attendance"]] = relationship(
        "Attendance",
        back_populates="staff",
        lazy="dynamic"
    )
    
    leaves: Mapped[List["Leave"]] = relationship(
        "Leave",
        back_populates="staff",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('experience_years >= 0', name='staff_positive_experience'),
        CheckConstraint('salary > 0 OR salary IS NULL', name='staff_positive_salary'),
        Index('idx_staff_name', 'first_name', 'last_name'),
        Index('idx_staff_role', 'role', 'status'),
        Index('idx_staff_hospital', 'hospital_id', 'status'),
        {'comment': 'Administrative and support staff management'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('role')
    def validate_role(self, key, value):
        valid_roles = [
            'receptionist', 'accountant', 'hr', 'admin', 'security',
            'housekeeping', 'lab_technician', 'pharmacist', 'it_support',
            'maintenance', 'dietitian', 'social_worker'
        ]
        if value.lower() not in valid_roles:
            raise ValueError(f"Role must be one of: {', '.join(valid_roles)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'on_leave', 'resigned', 'terminated', 'retired', 'suspended']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @property
    def full_name(self) -> str:
        if self.middle_name:
            return f"{self.first_name} {self.middle_name} {self.last_name}"
        return f"{self.first_name} {self.last_name}"
    
    def __repr__(self) -> str:
        return f"<Staff(id={self.id}, staff_id='{self.staff_id}', name='{self.full_name}', role='{self.role}')>"
    


==================================================

FILE: stock.py
----------------------------------------
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from datetime import datetime
from sqlalchemy.orm import relationship
from app.models.base import Base

class Stock(Base):
    __tablename__ = "stocks"

    id = Column(Integer, primary_key=True, index=True)
    medicine_id = Column(Integer, ForeignKey("medicines.id"))
    quantity = Column(Integer, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    medicine = relationship("Medicine")


==================================================

FILE: supplier.py
----------------------------------------
"""
Supplier Model
Supplier and vendor management for inventory
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List
import re

from .base import BaseModel


class Supplier(BaseModel):
    """
    Supplier/Vendor model
    """
    
    __tablename__ = "suppliers"
    
    # Supplier Details
    supplier_code: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    company_name: Mapped[str] = mapped_column(String(200), nullable=False)
    
    # Type
    supplier_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="medical_equipment, pharmaceutical, consumables, general, services"
    )
    
    # Contact Information
    contact_person: Mapped[str] = mapped_column(String(200), nullable=False)
    phone: Mapped[str] = mapped_column(String(20), nullable=False)
    alternate_phone: Mapped[Optional[str]] = mapped_column(String(20))
    email: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    website: Mapped[Optional[str]] = mapped_column(String(200))
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    country: Mapped[str] = mapped_column(String(100), default="USA")
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Business Details
    tax_id: Mapped[Optional[str]] = mapped_column(String(50), unique=True)
    license_number: Mapped[Optional[str]] = mapped_column(String(100))
    registration_number: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Bank Details
    bank_name: Mapped[Optional[str]] = mapped_column(String(200))
    account_number: Mapped[Optional[str]] = mapped_column(String(50))
    ifsc_code: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Rating
    rating: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, inactive, blacklisted, on_hold"
    )
    is_verified: Mapped[bool] = mapped_column(Boolean, default=False)
    
    # Payment Terms
    payment_terms: Mapped[Optional[str]] = mapped_column(String(100), comment="net_30, net_60, advance, cod")
    credit_limit: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Contract
    contract_start_date: Mapped[Optional[str]] = mapped_column(String(20))
    contract_end_date: Mapped[Optional[str]] = mapped_column(String(20))
    
    # Products Supplied
    products_supplied: Mapped[Optional[str]] = mapped_column(Text, comment="JSON array")
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Relationships
    purchase_orders: Mapped[List["PurchaseOrder"]] = relationship(
        "PurchaseOrder",
        back_populates="supplier",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('rating >= 1 AND rating <= 5 OR rating IS NULL', name='supplier_valid_rating'),
        Index('idx_supplier_type', 'supplier_type', 'status'),
        {'comment': 'Supplier and vendor management'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('supplier_type')
    def validate_supplier_type(self, key, value):
        valid_types = [
            'medical_equipment', 'pharmaceutical', 'consumables',
            'general', 'services', 'it', 'food'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Supplier type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'inactive', 'blacklisted', 'on_hold', 'pending_verification']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Supplier(id={self.id}, name='{self.name}', code='{self.supplier_code}')>"
    

==================================================

FILE: technician.py
----------------------------------------
"""
 Technician model - Lab/Radiology technicians
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime, Boolean
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Technician(Base):
    __tablename__ = "technicians"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    
    first_name = Column(String, nullable=False)
    last_name = Column(String, nullable=False)
    
    # Professional details
    employee_id = Column(String, unique=True, nullable=False)
    specialization = Column(String, nullable=False)  # Lab, Radiology, ECG, etc.
    qualification = Column(String, nullable=True)
    
    # Contact
    phone = Column(String, nullable=False)
    email = Column(String, nullable=True)
    
    # Employment
    date_of_joining = Column(DateTime, nullable=True)
    department = Column(String, nullable=True)  # Lab, Radiology
    
    # Status
    is_available = Column(Boolean, default=True)
    is_active = Column(Boolean, default=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships
    user = relationship("User")

==================================================

FILE: test_result.py
----------------------------------------
"""
 TestResult model - Detailed lab test results
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime, Text, Float
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class TestResult(Base):
    __tablename__ = "test_results"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    lab_test_id = Column(Integer, ForeignKey("lab_tests.id", ondelete="SET NULL"), nullable=True)
    doctor_id = Column(Integer, ForeignKey("doctors.id", ondelete="SET NULL"), nullable=True)
    
    test_name = Column(String, nullable=False)
    test_code = Column(String, nullable=True)
    
    # Results
    result_value = Column(String, nullable=True)
    result_unit = Column(String, nullable=True)
    normal_range = Column(String, nullable=True)
    
    # Interpretation
    status = Column(String, nullable=True)  # Normal, Abnormal, Critical
    interpretation = Column(Text, nullable=True)
    
    # Sample details
    sample_type = Column(String, nullable=True)  # Blood, Urine, etc.
    sample_collected_date = Column(DateTime, nullable=True)
    
    # Testing details
    tested_by = Column(String, nullable=True)
    test_date = Column(DateTime, nullable=False)
    verified_by = Column(String, nullable=True)
    
    notes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships
    patient = relationship("Patient")
    lab_test = relationship("LabTest")
    doctor = relationship("Doctor")

==================================================

FILE: transport.py
----------------------------------------
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime
from datetime import datetime
from sqlalchemy.orm import relationship
from app.models.base import Base

class Transport(Base):
    __tablename__ = "transports"

    id = Column(Integer, primary_key=True, index=True)
    ambulance_id = Column(Integer, ForeignKey("ambulances.id"))
    from_location = Column(String)
    to_location = Column(String)
    transport_time = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    ambulance = relationship("Ambulance")


==================================================

FILE: user.py
----------------------------------------
"""
User Model
Authentication and user management
"""

from sqlalchemy import Column, Integer, String, Boolean, Index, Text
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional
import re

from .base import BaseModel


class User(BaseModel):
    """
    User authentication model
    """
    
    __tablename__ = "users"
    
    # Basic Info
    username: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False, index=True)
    
    # Password (hashed)
    password_hash: Mapped[str] = mapped_column(String(255), nullable=False)
    
    # Personal Info
    first_name: Mapped[str] = mapped_column(String(100), nullable=False)
    last_name: Mapped[str] = mapped_column(String(100), nullable=False)
    phone: Mapped[Optional[str]] = mapped_column(String(20))
    
    # User Type
    user_type: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="admin, doctor, nurse, patient, staff"
    )
    
    # Role
    role_id: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Status
    is_verified: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    is_superuser: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    
    # Email Verification
    email_verified_at: Mapped[Optional[str]] = mapped_column(String(50))
    verification_token: Mapped[Optional[str]] = mapped_column(String(255))
    
    # Password Reset
    reset_token: Mapped[Optional[str]] = mapped_column(String(255))
    reset_token_expires: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Last Login
    last_login_at: Mapped[Optional[str]] = mapped_column(String(50))
    last_login_ip: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Security
    failed_login_attempts: Mapped[int] = mapped_column(Integer, default=0)
    locked_until: Mapped[Optional[str]] = mapped_column(String(50))
    
    # Two-Factor Authentication
    two_factor_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
    two_factor_secret: Mapped[Optional[str]] = mapped_column(String(255))
    
    # Profile
    profile_image: Mapped[Optional[str]] = mapped_column(String(500))
    bio: Mapped[Optional[str]] = mapped_column(Text)
    
    # Preferences
    preferences: Mapped[Optional[str]] = mapped_column(Text, comment="JSON user preferences")
    
    # Table Arguments
    __table_args__ = (
        Index('idx_user_type', 'user_type', 'is_active'),
        Index('idx_user_email_verified', 'email', 'is_verified'),
        {'comment': 'User authentication and management'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        if not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value.lower()
    
    @validates('user_type')
    def validate_user_type(self, key, value):
        valid_types = ['admin', 'doctor', 'nurse', 'patient', 'staff', 'pharmacist', 'technician']
        if value.lower() not in valid_types:
            raise ValueError(f"User type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @property
    def full_name(self) -> str:
        return f"{self.first_name} {self.last_name}"
    
    def __repr__(self) -> str:
        return f"<User(id={self.id}, username='{self.username}', type='{self.user_type}')>"

==================================================

FILE: vaccine.py
----------------------------------------
"""
 Vaccine model - Vaccination records
"""
from sqlalchemy import Column, Integer, ForeignKey, String, DateTime, Text
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.models.base import Base


class Vaccine(Base):
    __tablename__ = "vaccines"

    id = Column(Integer, primary_key=True, index=True)
    patient_id = Column(Integer, ForeignKey("patients.id", ondelete="CASCADE"), nullable=False)
    doctor_id = Column(Integer, ForeignKey("doctors.id", ondelete="SET NULL"), nullable=True)
    
    vaccine_name = Column(String, nullable=False)
    vaccine_type = Column(String, nullable=True)  # COVID-19, Flu, Hepatitis, etc.
    
    # Administration
    batch_number = Column(String, nullable=True)
    manufacturer = Column(String, nullable=True)
    
    dose_number = Column(Integer, default=1)  # 1st dose, 2nd dose, booster
    administered_date = Column(DateTime, nullable=False)
    
    # Next dose
    next_dose_date = Column(DateTime, nullable=True)
    
    # Details
    site_of_injection = Column(String, nullable=True)  # Left arm, Right arm
    administered_by = Column(String, nullable=True)
    
    # Reactions
    adverse_reactions = Column(Text, nullable=True)
    notes = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships
    patient = relationship("Patient")
    doctor = relationship("Doctor")

==================================================

FILE: vendor.py
----------------------------------------
"""
Vendor Model
Service vendors and contractors
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, Index, CheckConstraint
from sqlalchemy.orm import Mapped, mapped_column, validates
from typing import Optional
import re

from .base import BaseModel


class Vendor(BaseModel):
    """
    Service vendor model
    """
    
    __tablename__ = "vendors"
    
    # Vendor Details
    vendor_code: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    company_name: Mapped[str] = mapped_column(String(200), nullable=False)
    
    # Service Type
    service_type: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        index=True,
        comment="maintenance, housekeeping, security, it_services, laundry, catering, waste_disposal"
    )
    
    # Contact
    contact_person: Mapped[str] = mapped_column(String(200), nullable=False)
    phone: Mapped[str] = mapped_column(String(20), nullable=False)
    email: Mapped[str] = mapped_column(String(100), nullable=False)
    
    # Address
    address: Mapped[str] = mapped_column(Text, nullable=False)
    city: Mapped[str] = mapped_column(String(100), nullable=False)
    state: Mapped[str] = mapped_column(String(100), nullable=False)
    pincode: Mapped[str] = mapped_column(String(20), nullable=False)
    
    # Business Details
    tax_id: Mapped[Optional[str]] = mapped_column(String(50))
    license_number: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Contract
    contract_number: Mapped[Optional[str]] = mapped_column(String(50))
    contract_start_date: Mapped[Optional[str]] = mapped_column(String(20))
    contract_end_date: Mapped[Optional[str]] = mapped_column(String(20))
    contract_value: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Rating
    rating: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True
    )
    
    # Services Description
    services_description: Mapped[Optional[str]] = mapped_column(Text)
    
    # Notes
    notes: Mapped[Optional[str]] = mapped_column(Text)
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('rating >= 1 AND rating <= 5 OR rating IS NULL', name='vendor_valid_rating'),
        Index('idx_vendor_service_type', 'service_type', 'status'),
        {'comment': 'Service vendors and contractors'}
    )
    
    # Validators
    @validates('email')
    def validate_email(self, key, value):
        if value and not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', value):
            raise ValueError("Invalid email format")
        return value
    
    @validates('status')
    def validate_status(self, key, value):
        valid_statuses = ['active', 'inactive', 'terminated', 'suspended']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    def __repr__(self) -> str:
        return f"<Vendor(id={self.id}, name='{self.name}', service='{self.service_type}')>"

==================================================

FILE: ward.py
----------------------------------------
"""
Ward Model - Updated with Floor Reference
Hospital wards with floor location
"""

from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey, Index, CheckConstraint, Numeric
from sqlalchemy.orm import relationship, Mapped, mapped_column, validates
from typing import Optional, List

from .base import BaseModel


class Ward(BaseModel):
    """
    Ward model with floor reference
    Manages hospital wards across different floors
    """
    
    __tablename__ = "wards"
    
    # Basic Information
    ward_name: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    ward_code: Mapped[str] = mapped_column(String(20), unique=True, nullable=False, index=True)
    
    # Ward Type
    ward_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        index=True,
        comment="general, icu, nicu, picu, pediatric, maternity, isolation, burns, cardiac"
    )
    
    #  Floor Reference - NEW
    floor_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("floors.id", ondelete="SET NULL"),
        nullable=True,
        index=True
    )
    floor_number: Mapped[Optional[int]] = mapped_column(Integer, nullable=True, index=True)
    
    # Location
    department_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("departments.id", ondelete="SET NULL"),
        index=True
    )
    building: Mapped[Optional[str]] = mapped_column(String(50))
    wing: Mapped[Optional[str]] = mapped_column(String(50), comment="East, West, North, South, Central")
    section: Mapped[Optional[str]] = mapped_column(String(50), comment="A, B, C, etc.")
    
    # Capacity
    total_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    occupied_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    reserved_beds: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_rooms: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Staff Assignment
    head_nurse_id: Mapped[Optional[int]] = mapped_column(
        Integer,
        ForeignKey("nurses.id", ondelete="SET NULL")
    )
    total_nurses: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    total_staff: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Facilities
    has_isolation_room: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    has_emergency_equipment: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_nurse_station: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_waiting_area: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_oxygen_supply: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    has_ventilators: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
    ventilator_count: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
    
    # Contact
    contact_number: Mapped[Optional[str]] = mapped_column(String(20))
    extension: Mapped[Optional[str]] = mapped_column(String(10))
    
    # Status
    status: Mapped[str] = mapped_column(
        String(20),
        default='active',
        nullable=False,
        index=True,
        comment="active, inactive, maintenance, under_renovation"
    )
    
    # Additional Info
    description: Mapped[Optional[str]] = mapped_column(Text)
    special_notes: Mapped[Optional[str]] = mapped_column(Text)
    infection_control_level: Mapped[Optional[str]] = mapped_column(
        String(20),
        comment="standard, enhanced, strict"
    )
    
    # Relationships
    floor: Mapped[Optional["Floor"]] = relationship(
        "Floor",
        back_populates="wards",
        foreign_keys=[floor_id]
    )
    
    department: Mapped[Optional["Department"]] = relationship(
        "Department",
        back_populates="wards"
    )
    
    head_nurse: Mapped[Optional["Nurse"]] = relationship(
        "Nurse",
        back_populates="wards_managed",
        foreign_keys=[head_nurse_id]
    )
    
    rooms: Mapped[List["Room"]] = relationship(
        "Room",
        back_populates="ward",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    beds: Mapped[List["Bed"]] = relationship(
        "Bed",
        back_populates="ward",
        cascade="all, delete-orphan",
        lazy="dynamic"
    )
    
    admissions: Mapped[List["Admission"]] = relationship(
        "Admission",
        back_populates="ward",
        lazy="dynamic"
    )
    
    # Table Arguments
    __table_args__ = (
        CheckConstraint('total_beds >= 0', name='ward_positive_total_beds'),
        CheckConstraint('occupied_beds >= 0', name='ward_positive_occupied_beds'),
        CheckConstraint('reserved_beds >= 0', name='ward_positive_reserved_beds'),
        CheckConstraint('occupied_beds <= total_beds', name='ward_occupied_not_exceed_total'),
        CheckConstraint('reserved_beds <= total_beds', name='ward_reserved_not_exceed_total'),
        CheckConstraint('ventilator_count >= 0', name='ward_positive_ventilators'),
        Index('idx_ward_floor', 'floor_id', 'floor_number'),
        Index('idx_ward_department', 'department_id', 'status'),
        Index('idx_ward_type_status', 'ward_type', 'status'),
        {'comment': 'Hospital wards with floor locations'}
    )
    
    # Validators
    @validates('ward_type')
    def validate_ward_type(self, key, value):
        """Validate ward type"""
        valid_types = [
            'general', 'icu', 'nicu', 'picu', 'pediatric', 'maternity',
            'isolation', 'burns', 'cardiac', 'oncology', 'orthopedic',
            'neurology', 'surgical', 'medical', 'psychiatric'
        ]
        if value.lower() not in valid_types:
            raise ValueError(f"Ward type must be one of: {', '.join(valid_types)}")
        return value.lower()
    
    @validates('status')
    def validate_status(self, key, value):
        """Validate status"""
        valid_statuses = ['active', 'inactive', 'maintenance', 'under_renovation', 'closed']
        if value.lower() not in valid_statuses:
            raise ValueError(f"Status must be one of: {', '.join(valid_statuses)}")
        return value.lower()
    
    @validates('occupied_beds')
    def validate_occupied_beds(self, key, value):
        """Ensure occupied beds don't exceed total"""
        if value > self.total_beds:
            raise ValueError("Occupied beds cannot exceed total beds")
        return value
    
    # Properties
    @property
    def available_beds(self) -> int:
        """Calculate available beds"""
        return max(0, self.total_beds - self.occupied_beds - self.reserved_beds)
    
    @property
    def occupancy_rate(self) -> float:
        """Calculate occupancy percentage"""
        if self.total_beds == 0:
            return 0.0
        return round((self.occupied_beds / self.total_beds) * 100, 2)
    
    @property
    def is_full(self) -> bool:
        """Check if ward is at full capacity"""
        return self.available_beds == 0
    
    @property
    def is_critical_care(self) -> bool:
        """Check if ward is critical care unit"""
        return self.ward_type in ['icu', 'nicu', 'picu', 'cardiac']
    
    def __repr__(self) -> str:
        floor_info = f", floor={self.floor_number}" if self.floor_number is not None else ""
        return f"<Ward(id={self.id}, name='{self.ward_name}', type='{self.ward_type}'{floor_info})>"
    

==================================================

